<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard ‚Äî Cierre de Caja</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* ================================
       VARIABLES / RESET
       ================================ */
        :root {
            --primary: #5bc0de;
            --accent: #46b8da;
            --muted: #909ba7;
            --success: #63d471;
            --warning: #f8c050;
            --danger: #ff6b6b;
            --bg: #1e1e2d;
            --card: #2b2b3f;
            --line: #4a4a68;
            --text: #f1f1f1;
            --input: #3c3c58;
            --domicilio: #ff9933;
            --radius: 12px;
            --glass: rgba(255, 255, 255, 0.03);
            --max-width: 1200px;
            --shadow-1: 0 6px 20px rgba(0, 0, 0, 0.45);
            font-size: 16px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            justify-content: center;
            padding: 18px;
        }

        /* Contenedor central para facilitar reemplazo */
        .app {
            width: 100%;
            max-width: var(--max-width);
            display: flex;
            gap: 24px;
        }

        /* ================================
       SIDEBAR
       ================================ */
/* Footer del sidebar: pegado abajo */
#sidebar {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#sidebar-footer {
    margin-top: auto;
    padding-top: 20px;
}

/* Bot√≥n elegante */
.admin-btn {
    width: 100%;
    padding: 14px;
    font-size: 1.05rem;
    font-weight: 800;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: linear-gradient(135deg, #5bc0de, #2fa8c3);
    color: #1a1a25;
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    transition: 0.2s ease-in-out;
}

.admin-btn:hover {
    background: linear-gradient(135deg, #7bd9f0, #49c4dd);
    box-shadow: 0 6px 16px rgba(0,0,0,0.45);
}

/* M√≥vil ‚Üí sidebar fijo deslizable */
@media (max-width: 899px) {
    #sidebar-footer {
        padding-bottom: 20px;
    }
}


        #sidebar h2 {
            margin: 0 0 16px 0;
            font-size: 1.15rem;
            color: var(--primary);
            border-bottom: 1px solid var(--line);
            padding-bottom: 12px;
            font-weight: 800;
        }

        #sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px
        }

        #sidebar a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
            text-decoration: none;
            padding: 10px 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: background .18s, color .18s;
        }

        #sidebar a.active {
            background: var(--primary);
            color: var(--input);
        }

        #sidebar a:hover {
            background: var(--input);
            color: var(--primary)
        }

        /* ================================
       MAIN CONTENT
       ================================ */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: linear-gradient(180deg, var(--card), rgba(28, 28, 40, 0.9));
            border-radius: var(--radius);
            padding: 15px;
            border: 1px solid var(--line);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
        }

        h1 {
            margin: 0 0 10px 0;
            color: var(--primary);
            font-size: 1.4rem
        }

        h2 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: var(--text);
            font-weight: 700
        }

        /* Resumen superior */
        .total-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 18px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: var(--input);
            font-weight: 800;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
        }

        .total-summary .label {
            font-size: 0.95rem
        }

        .total-summary .amount {
            font-size: 1.6rem;
            letter-spacing: 0.6px
        }

        .esperado-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 14px;
        }

        .esperado-item {
            background: var(--glass);
            padding: 6px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--line)
        }

        .esperado-item strong {
            display: block;
            color: var(--primary);
            margin-top: 6px;
            font-weight: 800
        }

        /* Inputs / grupo de conteo */
        .metric-group {
            margin-top: 6px
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--line)
        }

        .input-row label {
            flex: 1;
            min-width: 150px;
            font-weight: 700
        }

        .input-right {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 320px;
            max-width: 100%
        }

        input[type="number"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: var(--input);
            color: var(--text);
            font-weight: 700;
            text-align: left;
            font-size: 1rem;
            transition: box-shadow .14s, border-color .14s, background .14s;
        }

        textarea {
            resize: vertical;
            text-align: left;
            padding: 12px
        }

        input:focus,
        textarea:focus {
            outline: none;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
            border-color: var(--primary)
        }

        .diff-indicator {
            min-width: 120px;
            text-align: right;
            font-weight: 800;
            font-size: 0.95rem;
            color: transparent;
            transition: color .18s, opacity .18s;
            opacity: 0;
        }

        /* Bot√≥n registrar */
        .actions {
            margin-top: 14px;
            display: flex;
            gap: 12px;
            align-items: center
        }

        .btn {
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            background: var(--primary);
            color: var(--input);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
            background: var(--line);
            color: var(--muted);
            width: 100%;
        }

        /* Diferencia total (solo mensaje resumido) */
        #diferenciaTotal {
            margin-top: 10px;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--line);
            text-align: center;
            font-weight: 800;
            transition: background .18s, border-color .18s, color .18s;
            background: transparent;
            color: var(--muted);
        }

       /* Historial / producido tables */
.producido-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: var(--input);
    border-radius: 8px;
    overflow: hidden;
}

.producido-table th,
.producido-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.25);
}

/* ENCABEZADOS CENTRADOS */
.producido-table th {
    background: var(--primary);
    color: var(--input);
    text-align: center;   /* üî• ENCABEZADOS CENTRADOS */
    font-weight: 800;
}

/* PRIMERA COLUMNA IZQUIERDA */
.producido-table td:first-child {
    text-align: left;     /* üî• M√âTODO DE PAGO */
    color: var(--primary);
    font-weight: 700;
}

/* TODAS LAS DEM√ÅS COLUMNAS NUM√âRICAS A LA DERECHA */
.producido-table td:not(:first-child) {
    text-align: right;    /* üî• N√öMEROS DERECHA */
}

/* SUBTOTAL */
.subtotal-row {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.02));
    font-weight: 900;
    color: var(--warning);
}


        /* ================================
       QUITAR FLECHAS EN number inputs
       ================================ */
        /* Chrome, Edge, Safari */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ================================
       MOBILE: TOPBAR + SIDEBAR HIDDEN / SLIDE
       ================================ */
        #mobile-topbar {
            display: none;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            /* üî• Pegada arriba */
            height: 60px;
            background: linear-gradient(90deg, #181822, #232332);
            /* üî• Solo curva abajo */
            padding: 10px 14px;
            align-items: center;
            gap: 12px;
            z-index: 1200;
        }


        #mobile-topbar .menu-btn {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform .22s ease;
        }

        /* small screens */
        @media (max-width: 899px) {
            body {
                padding: 12px
            }

            .app {
                flex-direction: column
            }
#sidebar {
    padding: 10px;
    position: fixed;
    left: 0;
    top: 0;                     /* üî• Pegado completamente arriba */
    height: 100vh;              /* üî• Ocupa toda la pantalla completa */
    width: 100%;
    background: #212133;
    z-index: 1199;
    transform: translateX(-110%);
    overflow-y: auto;           /* Para que el usuario pueda hacer scroll si es muy largo */
    box-shadow: 4px 0 20px rgba(0,0,0,0.6);
}


            #sidebar.active {
                transform: translateX(0)
            }

            #mobile-topbar {
                display: flex
            }

            .main {
                margin-top: 72px
            }

            .input-right {
                width: 100%;
                flex-direction: row;
                justify-content: space-between
            }

            .input-row label {
                min-width: 120px
            }
        }

        /* ancho peque√±o para inputs */
        @media (max-width:520px) {
            .esperado-grid {
                grid-template-columns: repeat(2, 1fr)
            }

            .input-row {
                flex-direction: column;
                align-items: flex-start
            }

            .input-right {
                width: 100%;
                flex-direction: column;
                align-items: stretch
            }

            .main {
                padding: 0
            }
        }

        @media (max-width: 899px) {
    .producido-group {
        overflow-x: auto;      /* üî• Scroll horizontal */
        -webkit-overflow-scrolling: touch; /* scroll suave en iPhone */
        padding-bottom: 10px;  /* espacio para el scroll */
    }

    .producido-table {
        min-width: 620px;      /* üî• Garantiza que haya scroll */
    }
}



    </style>
</head>

<body>
    <div class="app" role="application" aria-label="Panel de Cierre de Caja">
        <!-- SIDEBAR (se esconde en m√≥vil) -->
        <aside id="sidebar" aria-label="Navegaci√≥n principal">
            <h2>Gesti√≥n de Caja</h2>
            <nav aria-label="Secciones">
                <a href="#" class="nav-link active" data-section="cierre-section"
                    onclick="showSection(this); cargarPedidos()" id="link-cierre">üíµ Cierre de Caja</a>
                <a href="#" class="nav-link" data-section="historial-section"
                    onclick="showSection(this); consultarCierreHistorico(false)" id="link-hist">üìú Historial de
                    Cierres</a>
                <a href="#" class="nav-link" data-section="producido-section" onclick="showSection(this)"
                    id="link-prod">üìä Producido (Ventas)</a>
            </nav>
    <!-- ‚≠ê BOT√ìN PEGADO ABAJO ‚≠ê -->
    <div id="sidebar-footer">
        <button class="admin-btn" onclick="window.location.href='admin.html'">
            ‚öôÔ∏è Ir al Panel Admin
        </button>
    </div>

        </aside>

        <!-- MAIN CONTENT -->
        <main class="main" id="main-content">
            <!-- Barra m√≥vil -->
            <div id="mobile-topbar" aria-hidden="true">
                <button class="menu-btn" id="mobile-menu-btn" aria-label="Abrir men√∫">‚ò∞</button>
                <div style="font-weight:800;color:var(--primary)">Gesti√≥n de Caja</div>
            </div>

            <!-- PRODUCIDO (puede mostrarse/ocultarse) -->
            <section id="producido-section" class="card section-container" style="display:none">
                <h1>üìä Producido por M√©todo de Pago y Canal</h1>
                <p style="color:var(--muted);margin-bottom:14px">Resumen de ventas a corte: <strong
                        id="fechaCorteProducido">...</strong></p>

                <div id="producido-loading" style="color:var(--warning);margin-bottom:10px">‚è≥ Cargando
                    datos...</div>

                <div class="producido-group card" style="padding:14px">
                    <h2>Ventas Totales (Local + Domicilio)</h2>
                    <table class="producido-table" aria-live="polite">
                        <thead>
                            <tr>
                                <th>M√©todo de Pago</th>
                                <th>HOY</th>
                                <th><span id="mesActual"></span></th>
                                <th>A√ëO <span id="yearActual"></span></th>
                            </tr>
                        </thead>
                        <tbody id="producido-body-general"></tbody>
                    </table>
                </div>

                <div class="producido-group card" style="padding:14px;margin-top:12px">
                    <h2>Domicilios</h2>
                    <table class="producido-table" aria-live="polite">
                        <thead>
                            <tr>
                                <th>M√©todo de Pago</th>
                                <th>HOY</th>
                                <th><span id="mesActual2"></span></th>
                                <th>A√ëO <span id="yearActual2"></span></th>
                            </tr>
                        </thead>
                        <tbody id="producido-body-domicilio"></tbody>
                    </table>
                </div>

                <div class="producido-group card" style="padding:14px;margin-top:12px">
                    <h2>Total Ventas Netas</h2>
                    <table class="producido-table" aria-live="polite">
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th>HOY</th>
                                <th><span id="mesActual3"></span></th>
                                <th>A√ëO <span id="yearActual3"></span></th>
                            </tr>
                        </thead>
                        <tbody id="producido-body-local-neto"></tbody>
                    </table>
                </div>
            </section>

            <!-- CIERRE -->
            <section id="cierre-section" class="card section-container" style="display:block">
                <h1>üíµ Cierre de Caja del D√≠a</h1>
                <p style="color:var(--muted);margin-bottom:8px">Conciliaci√≥n para: <strong id="fechaActual">...</strong>
                </p>
                <div id="estadoCarga" style="color:var(--warning);margin-bottom:12px">‚è≥ Cargando datos
                    de ventas...</div>

                <div class="total-summary" role="region" aria-label="Resumen de ventas esperadas">
                    <div class="label">Total Venta Esperado:</div>
                    <div class="amount" id="ventaTotalSistema">$ 0</div>
                </div>

                <div class="esperado-grid" role="list" aria-label="Totales esperados por m√©todo">
                    <div class="esperado-item" role="listitem">Efectivo Esperado: <strong id="efectivoEsperado">$
                            0</strong></div>
                    <div class="esperado-item" role="listitem">Transferencia Esperada: <strong
                            id="transferenciaEsperada">$ 0</strong></div>
                    <div class="esperado-item" role="listitem">Efectivo/Transferencia: <strong id="mixtoEsperado">$
                            0</strong></div>
                    <div class="esperado-item" role="listitem">Otros Esperado: <strong id="otrosEsperado">$ 0</strong>
                    </div>
                </div>

                <div class="metric-group" aria-label="Conteo del cajero" style="margin-top:14px">
                    <h2>Contabilizado por el cajero</h2>

                    <div class="input-row">
                        <label for="efectivoReal">Efectivo contado</label>
                        <div class="input-right">
                            <input type="number" id="efectivoReal" placeholder="0.00" step="0.01" inputmode="decimal"
                                aria-label="Efectivo contado" />
                            <div id="diffEfectivo" class="diff-indicator" aria-live="polite"></div>
                        </div>
                    </div>

                    <div class="input-row">
                        <label for="transferenciaReal">Transferencia</label>
                        <div class="input-right">
                            <input type="number" id="transferenciaReal" placeholder="0.00" step="0.01"
                                inputmode="decimal" aria-label="Transferencia contada" />
                            <div id="diffTransferencia" class="diff-indicator" aria-live="polite"></div>
                        </div>
                    </div>

                    <div class="input-row">
                        <label for="mixtoReal">Efectivo / Transferencia</label>
                        <div class="input-right">
                            <input type="number" id="mixtoReal" placeholder="0.00" step="0.01" inputmode="decimal"
                                aria-label="Mixto contado" />
                            <div id="diffMixto" class="diff-indicator" aria-live="polite"></div>
                        </div>
                    </div>

                    <div class="input-row">
                        <label for="otrosReal">Otros pagos</label>
                        <div class="input-right">
                            <input type="number" id="otrosReal" placeholder="0.00" step="0.01" inputmode="decimal"
                                aria-label="Otros contados" />
                            <div id="diffOtros" class="diff-indicator" aria-live="polite"></div>
                        </div>
                    </div>
                </div>

                <!-- Resultado total: SOLO MENSAJE (CUADRADO/SOBRANTE/FALTANTE) -->
                <div id="diferenciaTotal" role="status" aria-live="polite">
                    Ingrese los valores contados para calcular la diferencia total.
                </div>

                <div class="card" style="margin-top:12px;padding:14px">
                    <div style="display:flex;flex-direction:column;gap:10px">
                        <label for="responsableCierre" style="font-weight:700">Responsable que cierra</label>
                        <input type="text" id="responsableCierre" placeholder="Ej: Juan P√©rez"
                            aria-label="Responsable del cierre" />
                        <label for="notasCierre" style="font-weight:700;margin-top:6px">Notas (opcional)</label>
                        <textarea id="notasCierre" rows="3" placeholder="Ej: Faltante por cambio mal dado"></textarea>

                        <div class="actions">
                            <button id="btnRegistrarCierre" class="btn" disabled aria-disabled="true">üîí Registrar
                                cierre</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- HISTORIAL -->
            <section id="historial-section" class="card section-container" style="display:none">
                <h1>üìú Historial de cierres</h1>
                <p style="color:var(--muted)">Consulta registros anteriores</p>

                <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
                    <label for="fechaConsulta" style="font-weight:700">Buscar por fecha</label>
                    <input type="date" id="fechaConsulta" />
                    <button class="btn" style="background:var(--success)" onclick="consultarCierreHistorico(true)">üîé
                        Buscar</button>
                    <button class="btn" style="background:var(--muted)" onclick="consultarCierreHistorico(false)">üìú Ver
                        todo</button>
                </div>

                <div id="resultadoConsulta" style="margin-top:14px;color:var(--muted)">Haga clic en Buscar o Ver todo
                    para cargar.</div>
            </section>

        </main>
    </div>

    <script>
        /* =================================
           CONFIG B√ÅSICA
           ================================= */
        const API_URL_PEDIDOS = "https://script.google.com/macros/s/AKfycbwez78KX4oEXCGWV_olvy_J1C8YwURxN-1YaZiYYqQJPVLAJuaRI_5EVl4v14OMjonM/exec";
        const API_URL_CIERRES = "https://script.google.com/macros/s/AKfycbzoEN5CldFTrWRoNVdpDN0fQP-bx77rlpUdwdWi1HAIjBrGv3I0iuYnWUndPAAwvDxujg/exec";

        let sistemaData = null;
        let cierreData = null;
        let allPedidos = [];
        const RANGO_TOLERANCIA = 500;

        // UTIL: formateo COP sin decimales
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.round(Number(amount) || 0));
        }

        function formatFechaActual(date) {
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function formatDateToSheets(date) {
            const p = String(date).split('-');
            if (p.length === 3) return `${p[2]}/${p[1]}/${p[0]}`;
            return date;
        }

        function formatFechaCorte(date) {
            return date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        /* =================================
           NAVEGACI√ìN ENTRE SECCIONES
           ================================= */
        function showSection(element) {
            const target = element.getAttribute('data-section');
            document.querySelectorAll('.section-container').forEach(s => s.style.display = 'none');
            document.getElementById(target).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            element.classList.add('active');

            // cerrar sidebar en m√≥vil si est√° abierto
            const sb = document.getElementById('sidebar');
            if (window.innerWidth <= 899 && sb.classList.contains('active')) {
                sb.classList.remove('active');
            }
        }

        /* =================================
           CARGA DE DATOS (PEDIDOS -> PRODUCIDO + CIERRE)
           ================================= */
        async function cargarPedidos() {
            const estadoCargaCierre = document.getElementById('estadoCarga');
            const estadoCargaProducido = document.getElementById('producido-loading');
            estadoCargaCierre.textContent = '‚è≥ Cargando...';
            estadoCargaProducido.textContent = '‚è≥ Cargando datos para el an√°lisis...';

            try {
                const today = new Date();
                const todayStr = formatFechaActual(today);

                document.getElementById('fechaActual').textContent = formatFechaCorte(today);
                document.getElementById('fechaCorteProducido').textContent = formatFechaCorte(today);

                const monthName = today.toLocaleDateString('es-ES', { month: 'long' }).toUpperCase();
                const yearNow = today.getFullYear();
                document.getElementById('mesActual').textContent = monthName;
                document.getElementById('mesActual2').textContent = monthName;
                document.getElementById('mesActual3').textContent = monthName;
                document.getElementById('yearActual').textContent = yearNow;
                document.getElementById('yearActual2').textContent = yearNow;
                document.getElementById('yearActual3').textContent = yearNow;

                const resp = await fetch(API_URL_PEDIDOS);
                if (!resp.ok) throw new Error('Error en la API de pedidos: ' + resp.status);
                allPedidos = await resp.json();

                // calcular cierre del d√≠a
                const { cierreDataHoy, pedidosContados } = calcularDatosCierre(allPedidos, todayStr);
                sistemaData = cierreDataHoy;
                renderEsperado(sistemaData);

                estadoCargaCierre.textContent = `‚úÖ ${pedidosContados} pedidos procesados para cierre.`;
                estadoCargaCierre.style.color = 'var(--success)';

                // producido
                const prodGeneral = calcularProducido(allPedidos, today, 'general');
                renderProducido(prodGeneral, 'producido-body-general');

                const prodDomi = calcularProducido(allPedidos, today, 'domicilio');
                renderProducidoSoloTotal(prodDomi, 'producido-body-domicilio');

                renderTotalLocalNeto(prodGeneral, prodDomi, 'producido-body-local-neto');

                estadoCargaProducido.textContent = `‚úÖ ${allPedidos.length} pedidos procesados para producido.`;
                estadoCargaProducido.style.color = 'var(--success)';

                // recalcular diferencias (si el usuario ya escribi√≥ algo)
                calcularDiferenciasTiempoReal();
                checkResponsable();

            } catch (err) {
                console.error('Error al cargar pedidos:', err);
                estadoCargaCierre.textContent = '‚ùå Error al cargar datos. Revisa la API.';
                estadoCargaCierre.style.color = 'var(--danger)';
                document.getElementById('producido-loading').textContent = '‚ùå Error al cargar datos.';
                document.getElementById('producido-loading').style.color = 'var(--danger)';
            }
        }

        function cleanAndParseTotal(totalPagarString) {
            return parseFloat(String(totalPagarString).replace('$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
        }

        function determinarCanal(pedido) {
            const ref = String(pedido.referencia || pedido.idPedido || '').toUpperCase();
            const canalField = String(pedido.canalVenta || '').toUpperCase();
            if (ref.startsWith('DOMICILIO#')) return 'domicilio';
            if (canalField.includes('DOMICILIO')) return 'domicilio';
            return 'local';
        }

        function calcularDatosCierre(pedidos, todayString) {
            let ventaTotalEfectivo = 0, ventaTotalTransferencia = 0, ventaTotalMixto = 0, ventaTotalOtros = 0, pedidosContados = 0;
            pedidos.forEach(p => {
                const totalPagar = cleanAndParseTotal(p.totalPagar);
                if (String(p.fecha).trim() === todayString) {
                    pedidosContados++;
                    const metodo = String(p.metodoPago || '').toLowerCase().trim();
                    if (metodo === 'efectivo') ventaTotalEfectivo += totalPagar;
                    else if (metodo === 'transferencia') ventaTotalTransferencia += totalPagar;
                    else if (metodo.includes('efectivo/transferencia')) ventaTotalMixto += totalPagar;
                    else ventaTotalOtros += totalPagar;
                }
            });
            return {
                cierreDataHoy: {
                    ventaTotalEfectivo: Math.round(ventaTotalEfectivo),
                    ventaTotalTransferencia: Math.round(ventaTotalTransferencia),
                    ventaTotalMixto: Math.round(ventaTotalMixto),
                    ventaTotalOtros: Math.round(ventaTotalOtros)
                },
                pedidosContados
            };
        }

        function calcularProducido(pedidos, today, tipo) {
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const todayString = formatFechaActual(today);
            const producido = {
                efectivo: { hoy: 0, mes: 0, anual: 0 },
                transferencia: { hoy: 0, mes: 0, anual: 0 },
                mixto: { hoy: 0, mes: 0, anual: 0 },
                otros: { hoy: 0, mes: 0, anual: 0 }
            };

            pedidos.forEach(p => {
                if (tipo === 'domicilio') {
                    const costoDomicilio = Number(p.costoDomicilio) || 0;
                    const fechaStr = String(p.fecha).trim();
                    if (!fechaStr || fechaStr.split('/').length !== 3) return;
                    const [dd, mm, yyyy] = fechaStr.split('/').map(n => parseInt(n, 10));
                    const fechaPedido = new Date(yyyy, mm - 1, dd);
                    if (fechaStr === todayString) producido.efectivo.hoy += costoDomicilio;
                    if (fechaPedido.getMonth() === currentMonth && fechaPedido.getFullYear() === currentYear) producido.efectivo.mes += costoDomicilio;
                    if (fechaPedido.getFullYear() === currentYear) producido.efectivo.anual += costoDomicilio;
                    return;
                }

                const totalPagar = cleanAndParseTotal(p.totalPagar);
                const fechaStr = String(p.fecha).trim();
                if (!fechaStr || fechaStr.split('/').length !== 3) return;
                const [dd, mm, yyyy] = fechaStr.split('/').map(n => parseInt(n, 10));
                const pedidoDate = new Date(yyyy, mm - 1, dd);
                const metodoPago = String(p.metodoPago || '').toLowerCase().trim();
                let canalPago = 'otros';
                if (metodoPago === 'efectivo') canalPago = 'efectivo';
                else if (metodoPago === 'transferencia') canalPago = 'transferencia';
                else if (metodoPago.includes('efectivo/transferencia')) canalPago = 'mixto';
                if (fechaStr === todayString) producido[canalPago].hoy += totalPagar;
                if (pedidoDate.getFullYear() === currentYear && pedidoDate.getMonth() === currentMonth) producido[canalPago].mes += totalPagar;
                if (pedidoDate.getFullYear() === currentYear) producido[canalPago].anual += totalPagar;
            });

            ['efectivo', 'transferencia', 'mixto', 'otros'].forEach(c => {
                ['hoy', 'mes', 'anual'].forEach(t => {
                    producido[c][t] = Math.round(producido[c][t] * 100) / 100;
                });
            });

            return producido;
        }

        function renderProducido(data, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            const metodos = [{ key: 'efectivo', label: 'EFECTIVO' }, { key: 'transferencia', label: 'TRANSFERENCIA' }, { key: 'mixto', label: 'EFECTIVO/TRANSFERENCIA' }, { key: 'otros', label: 'OTROS M√âTODOS' }];
            let totalHoy = 0, totalMes = 0, totalAnual = 0;
            metodos.forEach(m => {
                const hoy = data[m.key].hoy, mes = data[m.key].mes, anual = data[m.key].anual;
                totalHoy += hoy; totalMes += mes; totalAnual += anual;
                const row = document.createElement('tr');
                row.innerHTML = `<td>${m.label}</td><td>${formatCurrency(hoy)}</td><td>${formatCurrency(mes)}</td><td>${formatCurrency(anual)}</td>`;
                tbody.appendChild(row);
            });
            const subtotal = document.createElement('tr');
            subtotal.classList.add('subtotal-row');
            subtotal.innerHTML = `<td>TOTAL</td><td>${formatCurrency(totalHoy)}</td><td>${formatCurrency(totalMes)}</td><td>${formatCurrency(totalAnual)}</td>`;
            tbody.appendChild(subtotal);
        }

        function renderProducidoSoloTotal(data, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            const totalHoy = data.efectivo.hoy + data.transferencia.hoy + data.mixto.hoy + data.otros.hoy;
            const totalMes = data.efectivo.mes + data.transferencia.mes + data.mixto.mes + data.otros.mes;
            const totalAnual = data.efectivo.anual + data.transferencia.anual + data.mixto.anual + data.otros.anual;
            const row = document.createElement('tr');
            row.classList.add('subtotal-row');
            row.innerHTML = `<td>TOTAL DOMICILIOS</td><td>${formatCurrency(totalHoy)}</td><td>${formatCurrency(totalMes)}</td><td>${formatCurrency(totalAnual)}</td>`;
            tbody.appendChild(row);
        }

        function renderTotalLocalNeto(generalData, domicilioData, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            const totalGeneralHoy = generalData.efectivo.hoy + generalData.transferencia.hoy + generalData.mixto.hoy + generalData.otros.hoy;
            const totalGeneralMes = generalData.efectivo.mes + generalData.transferencia.mes + generalData.mixto.mes + generalData.otros.mes;
            const totalGeneralAnual = generalData.efectivo.anual + generalData.transferencia.anual + generalData.mixto.anual + generalData.otros.anual;
            const totalDomiHoy = domicilioData.efectivo.hoy + domicilioData.transferencia.hoy + domicilioData.mixto.hoy + domicilioData.otros.hoy;
            const totalDomiMes = domicilioData.efectivo.mes + domicilioData.transferencia.mes + domicilioData.mixto.mes + domicilioData.otros.mes;
            const totalDomiAnual = domicilioData.efectivo.anual + domicilioData.transferencia.anual + domicilioData.mixto.anual + domicilioData.otros.anual;
            const hoyNeto = totalGeneralHoy - totalDomiHoy;
            const mesNeto = totalGeneralMes - totalDomiMes;
            const anualNeto = totalGeneralAnual - totalDomiAnual;
            const row = document.createElement('tr');
            row.classList.add('subtotal-row');
            row.innerHTML = `<td>LOCAL NETO</td><td>${formatCurrency(hoyNeto)}</td><td>${formatCurrency(mesNeto)}</td><td>${formatCurrency(anualNeto)}</td>`;
            tbody.appendChild(row);
        }

        /* =================================
           RENDER VALORES ESPERADOS
           ================================= */
        function renderEsperado(data) {
            const ventaTotalSistema = data.ventaTotalEfectivo + data.ventaTotalTransferencia + data.ventaTotalMixto + data.ventaTotalOtros;
            document.getElementById('efectivoEsperado').textContent = formatCurrency(data.ventaTotalEfectivo);
            document.getElementById('transferenciaEsperada').textContent = formatCurrency(data.ventaTotalTransferencia);
            document.getElementById('mixtoEsperado').textContent = formatCurrency(data.ventaTotalMixto);
            document.getElementById('otrosEsperado').textContent = formatCurrency(data.ventaTotalOtros);
            document.getElementById('ventaTotalSistema').textContent = formatCurrency(ventaTotalSistema);
        }

        /* =================================
           CALCULAR DIFERENCIAS EN TIEMPO REAL
           - Nota: Indicadores individuales permanecen ocultos
                   hasta que el usuario escriba.
           - diferenciaTotal mostrar√° SOLO el mensaje resumido.
           ================================= */
        const campos = ['efectivoReal', 'transferenciaReal', 'mixtoReal', 'otrosReal'];
        campos.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', calcularDiferenciasTiempoReal);
                // evitar que el valor vac√≠o devuelva "0" visualmente en indicador
                el.addEventListener('focus', () => { el.select(); });
            }
        });

        function calcularDiferenciasTiempoReal() {
            if (!sistemaData) {
                document.getElementById('diferenciaTotal').textContent = '‚ö†Ô∏è Esperando datos del sistema...';
                return;
            }

            // Leer valores contados (si est√° vac√≠o -> NaN -> tratamos como null)
            const contadoEfectivo = parseFloat(document.getElementById('efectivoReal').value || 0);
            const contadoTransferencia = parseFloat(document.getElementById('transferenciaReal').value || 0);
            const contadoMixto = parseFloat(document.getElementById('mixtoReal').value || 0);
            const contadoOtros = parseFloat(document.getElementById('otrosReal').value || 0);

            const esperadoEfectivo = sistemaData.ventaTotalEfectivo || 0;
            const esperadoTransferencia = sistemaData.ventaTotalTransferencia || 0;
            const esperadoMixto = sistemaData.ventaTotalMixto || 0;
            const esperadoOtros = sistemaData.ventaTotalOtros || 0;

            const diffEfectivo = contadoEfectivo - esperadoEfectivo;
            const diffTransferencia = contadoTransferencia - esperadoTransferencia;
            const diffMixto = contadoMixto - esperadoMixto;
            const diffOtros = contadoOtros - esperadoOtros;

            const diffTotal = diffEfectivo + diffTransferencia + diffMixto + diffOtros;

            // actualizar indicadores individuales SOLO si usuario escribi√≥ algo en ese campo
            actualizarIndicadorIndividual('diffEfectivo', diffEfectivo, document.getElementById('efectivoReal').value);
            actualizarIndicadorIndividual('diffTransferencia', diffTransferencia, document.getElementById('transferenciaReal').value);
            actualizarIndicadorIndividual('diffMixto', diffMixto, document.getElementById('mixtoReal').value);
            actualizarIndicadorIndividual('diffOtros', diffOtros, document.getElementById('otrosReal').value);

            // actualizar indicador TOTAL (solo mensaje resumido)
            renderDiferenciaTotal(diffTotal);

            // preparar cierreData para env√≠o
            cierreData = {
                fecha: formatFechaActual(new Date()),
                efectivoContado: contadoEfectivo, efectivoEsperado: esperadoEfectivo, diferenciaEfectivo: diffEfectivo,
                transferenciaContada: contadoTransferencia, transferenciaEsperada: esperadoTransferencia, diferenciaTransferencia: diffTransferencia,
                mixtoContado: contadoMixto, mixtoEsperado: esperadoMixto, diferenciaMixto: diffMixto,
                otrosContados: contadoOtros, otrosEsperados: esperadoOtros, diferenciaOtros: diffOtros,
                diferenciaTotal: diffTotal,
                totalSistema: esperadoEfectivo + esperadoTransferencia + esperadoMixto + esperadoOtros,
                totalContado: contadoEfectivo + contadoTransferencia + contadoMixto + contadoOtros
            };

            checkResponsable();
        }

        function actualizarIndicadorIndividual(elementId, diferencia, inputValue) {
            const el = document.getElementById(elementId);
            if (!el) return;

            // Si el usuario NO ha escrito nada ‚Üí ocultar indicador
            if (!inputValue || inputValue === "") {
                el.textContent = "";
                el.style.opacity = 0;
                el.style.color = 'transparent';
                return;
            }

            const abs = Math.abs(diferencia);
            if (abs < RANGO_TOLERANCIA) {
                el.style.color = 'var(--success)';
                el.textContent = '‚úÖ Cuadrado';
            } else if (diferencia > 0) {
                el.style.color = 'var(--warning)';
                el.textContent = `‚ñ≤ Sobra: ${formatCurrency(diferencia)}`;
            } else {
                el.style.color = 'var(--danger)';
                el.textContent = `‚ñº Falta: ${formatCurrency(Math.abs(diferencia))}`;
            }
            el.style.opacity = 1;
        }

        function renderDiferenciaTotal(diferenciaTotal) {
            const cont = document.getElementById('diferenciaTotal');
            const abs = Math.abs(diferenciaTotal);
            let color = 'var(--muted)', icon = '', mensaje = '';

            if (Math.abs(diferenciaTotal) < RANGO_TOLERANCIA) {
                color = 'var(--success)';
                icon = '‚≠ê';
                mensaje = 'CIERRE CUADRADO';
            } else if (diferenciaTotal > 0) {
                color = 'var(--warning)';
                icon = 'üí∞';
                mensaje = `SOBRANTE DE ${formatCurrency(abs)}`;
            } else {
                color = 'var(--danger)';
                icon = 'üö®';
                mensaje = `FALTANTE DE ${formatCurrency(abs)}`;
            }

            cont.style.backgroundColor = color + '20';
            cont.style.borderColor = color;
            cont.style.color = color;
            cont.innerHTML = `<div style="font-size:1.15rem;font-weight:800">${icon} ${mensaje}</div>`;

            // ajustar bot√≥n de registrar (solo visual)
            const btn = document.getElementById('btnRegistrarCierre');
            if (btn) {
                btn.style.background = color;
            }
        }

        /* =================================
           REGISTRAR CIERRE (POST)
           ================================= */
        async function registrarCierreAPI() {
            const responsable = document.getElementById('responsableCierre').value.trim();
            const notas = document.getElementById('notasCierre').value.trim();

            if (!confirm('¬øDesea registrar el cierre con los valores actuales?')) return;
            if (!cierreData || !sistemaData) {
                alert('Faltan datos para registrar. Aseg√∫rese de que los datos del sistema est√©n cargados y haya hecho el conteo.');
                return;
            }
            if (!responsable || responsable.length < 2) {
                alert('Ingrese el nombre del responsable (m√≠nimo 2 caracteres).');
                return;
            }

            const payload = { ...cierreData, usuario: responsable, notas };

            const btn = document.getElementById('btnRegistrarCierre');
            const original = btn.textContent;
            btn.disabled = true; btn.textContent = 'Enviando...';

            try {
                const resp = await fetch(API_URL_CIERRES, { method: 'POST', body: JSON.stringify(payload) });
                const data = await resp.json();
                if (data.status === 'ok') {
                    alert('‚úÖ Cierre registrado con √©xito.');
                    btn.textContent = '‚úÖ Registrado';
                    btn.disabled = true;
                } else {
                    throw new Error(data.message || 'Error en API');
                }
            } catch (err) {
                console.error('Error registrar cierre:', err);
                alert('‚ùå Error al registrar. Revisa la consola o la API.');
                btn.disabled = false; btn.textContent = original;
                btn.style.background = 'var(--danger)';
            }
        }

        /* =================================
           HISTORIAL (CONSULTA / ELIMINAR)
           ================================= */
        async function consultarCierreHistorico(filtrarPorFecha) {
            const inputFecha = document.getElementById('fechaConsulta');
            const resultadoDiv = document.getElementById('resultadoConsulta');

            let url = API_URL_CIERRES;
            let fecha = null;
            if (filtrarPorFecha) {
                if (!inputFecha.value) { resultadoDiv.textContent = 'Selecciona una fecha.'; resultadoDiv.style.color = 'var(--danger)'; return; }
                fecha = formatDateToSheets(inputFecha.value);
                url = `${API_URL_CIERRES}?fecha=${fecha}`;
            }
            resultadoDiv.innerHTML = filtrarPorFecha ? `‚è≥ Buscando cierres: ${fecha}...` : '‚è≥ Cargando todos los cierres...';
            resultadoDiv.style.color = 'var(--muted)';

            try {
                const resp = await fetch(url);
                const data = await resp.json();
                if (data.status === 'ok') {
                    if (Array.isArray(data.resultados) && data.resultados.length) {
                        let html = `<h3>‚úÖ ${data.resultados.length} cierre(s) encontrados</h3>`;
                        data.resultados.sort((a, b) => {
                            const dateA = new Date(a["Fecha Cierre"].split('/').reverse().join('-') + ' ' + (a["Hora Cierre"] || '00:00'));
                            const dateB = new Date(b["Fecha Cierre"].split('/').reverse().join('-') + ' ' + (b["Hora Cierre"] || '00:00'));
                            return dateB - dateA;
                        });
                        data.resultados.forEach(c => {
                            const diff = parseFloat(c["Diferencia Total"]) || 0;
                            const abs = Math.abs(diff);
                            let color = diff > 0 ? 'var(--warning)' : diff < 0 ? 'var(--danger)' : 'var(--success)';
                            let estado = Math.abs(diff) < RANGO_TOLERANCIA ? 'Cuadrado' : (diff > 0 ? `SOBRA ${formatCurrency(abs)}` : `FALTA ${formatCurrency(abs)}`);
                            const rowIndex = parseInt(c["Fila ID"]);
                            html += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-top:8px;background:var(--input);border-left:4px solid ${color}">
                  <div>
                    <div style="font-weight:800">${c["Fecha Cierre"]} ${c["Hora Cierre"] || ''}</div>
                    <div style="color:var(--muted);font-size:0.95rem">Responsable: ${c["Responsable Cierre"] || ''}</div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center">
                    <div style="font-weight:800;color:${color}">${estado}</div>
                    <button style="background:transparent;border:none;color:var(--danger);cursor:pointer" onclick="eliminarCierreAPI(${rowIndex})">EliminarüóëÔ∏è</button>
                  </div>
                </div>
              `;
                        });
                        resultadoDiv.innerHTML = html;
                    } else {
                        resultadoDiv.innerHTML = `<h3>‚ö†Ô∏è No se encontraron cierres para el periodo.</h3>`;
                        resultadoDiv.style.color = 'var(--warning)';
                    }
                } else {
                    resultadoDiv.innerHTML = `‚ùå Error: ${data.message || 'API'}`; resultadoDiv.style.color = 'var(--danger)';
                }
            } catch (err) {
                console.error('Error consultar cierre:', err);
                resultadoDiv.innerHTML = '‚ùå Error de conexi√≥n al consultar la API.'; resultadoDiv.style.color = 'var(--danger)';
            }
        }

        async function eliminarCierreAPI(rowIndex) {
            if (!confirm(`Eliminar registro Fila ID ${rowIndex}? Esta acci√≥n es irreversible.`)) return;
            const resultadoDiv = document.getElementById('resultadoConsulta');
            resultadoDiv.innerHTML = `‚è≥ Eliminando fila ${rowIndex}...`;
            try {
                const resp = await fetch(`${API_URL_CIERRES}?action=delete&rowIndex=${rowIndex}`, { method: 'GET' });
                const data = await resp.json();
                if (data.status === 'ok') {
                    alert('‚úÖ Eliminado correctamente.');
                    consultarCierreHistorico(false);
                } else throw new Error(data.message || 'Error eliminar');
            } catch (err) {
                console.error('Error eliminar:', err);
                resultadoDiv.innerHTML = '‚ùå Error al eliminar el registro.'; resultadoDiv.style.color = 'var(--danger)';
            }
        }

        /* =================================
           CHECK RESPONSABLE (habilitar bot√≥n)
           ================================= */
        function checkResponsable() {
            const responsable = document.getElementById('responsableCierre').value.trim();
            const btn = document.getElementById('btnRegistrarCierre');
            const enabled = Boolean(sistemaData) && responsable.length > 2;
            btn.disabled = !enabled;
            btn.setAttribute('aria-disabled', String(!enabled));
        }

        /* =================================
           MOBILE MENU TOGGLE
           ================================= */
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
            // transform icon toggling (simple)
            const el = document.getElementById('mobile-menu-btn');
            el.textContent = el.textContent === '‚ò∞' ? '‚úï' : '‚ò∞';
        });

        /* =================================
           EVENTOS INICIALES
           ================================= */
        document.addEventListener('DOMContentLoaded', () => {
            // set fecha en fechaConsulta
            const today = new Date();
            const yyyy = today.getFullYear(), mm = String(today.getMonth() + 1).padStart(2, '0'), dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('fechaConsulta').value = `${yyyy}-${mm}-${dd}`;

            // asignar listeners
            document.getElementById('btnRegistrarCierre').addEventListener('click', registrarCierreAPI);
            document.getElementById('responsableCierre').addEventListener('input', checkResponsable);

            // cargar datos iniciales
            cargarPedidos();

            // asegurar que cierre-section se muestre al inicio
            const cierreLink = document.getElementById('link-cierre');
            if (cierreLink) showSection(cierreLink);
        });

        // mejorar UX: cerrar sidebar al redimensionar a desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth > 899) document.getElementById('sidebar').classList.remove('active');
        });

        /* =================================
           FIN DEL SCRIPT
           ================================= */
    </script>
</body>

</html>