<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üìä Estad√≠sticas</title>
  <link rel="icon" type="image/png" href="img/icono_tienda.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    :root{
      --primary:#007bff; --success:#28a745; --warn:#ffc107; --bg:#f0f2f5;
      --card-bg:#fff; --muted:#6c757d;
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
    }
    body{margin:0;background:var(--bg);color:#212529;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    header h1{margin:0;font-size:1.4rem;font-weight:700;}
    .top-actions{display:flex;gap:8px;align-items:center}
    button, select{cursor:pointer;font-family:inherit;font-weight:600;}
    button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;transition:background-color 0.2s}
    button:hover{background-color:#0056b3}
    button.ghost{background:transparent;border:1px solid #ced4da;color:#212529}
    button.ghost:hover{background-color:#e9ecef}
    .layout{display:grid;grid-template-columns:300px 1fr;gap:18px}
    /* sidebar */
    .sidebar{background:var(--card-bg);padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);height:fit-content;}
    .tabs{display:flex;flex-direction:column;gap:6px}
    .tab{padding:12px;border-radius:8px;font-weight:600;color:#343a40;background:#f8f9fa;border:1px solid #dee2e6;cursor:pointer;transition:all 0.2s;}
    .tab:hover{background-color:#e9ecef}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
    .small{font-size:0.85rem;color:var(--muted)}
    /* main */
    .main{min-height:80vh}
    .panel{background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:18px;}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
    .kpi{background:#fff;padding:15px;border-radius:8px;text-align:center;border-bottom:3px solid var(--primary);box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    .kpi h3{margin:0;color:var(--muted);font-weight:500;font-size:0.9rem}
    .kpi p{margin:8px 0 0;font-weight:800;font-size:1.5rem;line-height:1.2}
    .kpi.ventas{border-bottom-color:var(--success);}
    .kpi.promedio{border-bottom-color:var(--warn);}
    .kpi.pedidos{border-bottom-color:var(--primary);}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:15px;margin-top:15px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
    th,td{padding:12px;text-align:left;font-size:0.95rem;border-bottom:1px solid #e9ecef}
    th{background:var(--primary);color:#fff;font-weight:600;position:sticky;top:0}
    tr:last-child td{border-bottom:none}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .info-box{background:#e9f7fe;padding:12px;border-radius:8px;color:#004085;border:1px solid #b8daff;font-size:0.9rem;}
    .report{white-space:pre-wrap;font-family:'Consolas', 'Courier New', monospace;background:#f8f9fa;padding:15px;border:1px solid #e9ecef}
    #tendenciasRapidas li{margin-bottom:5px;}
    
    @media(max-width:1024px){.layout{grid-template-columns:1fr;}.sidebar{order:2}}
  </style>
</head>
<body>
  <div class="volver-admin">
<button onclick="window.location.href='admin.html'">‚¨ÖÔ∏è Admin</button>
</div>
  <header>

    <div>
      <h1>üìà Panel de Estad√≠sticas</h1>
      <div class="small">Datos en tiempo real / Rango: <span id="rangoLabel">√öltimos 30 d√≠as</span></div>
    </div>

    <div class="top-actions">
      <div class="controls">
        <label class="small">Rango:</label>
        <select id="rango">
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="30" selected>√öltimos 30 d√≠as</option>
          <option value="90">√öltimos 90 d√≠as</option>
          <option value="todo">Todo</option>
        </select>
        <button id="btnRecargar">üîÉ Recargar Datos</button>
        <button id="btnExport" class="ghost">‚¨áÔ∏è Exportar Resumen CSV</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>Secciones</strong>
        <small class="small" id="estado">Cargando configuraci√≥n...</small>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-section="resumen">Sumario General</div>
        <div class="tab" data-section="clientes">Clientes VIP</div>
        <div class="tab" data-section="productos">Productos Top</div>
        <div class="tab" data-section="tendencias">An√°lisis de Picos</div>
        <div class="tab" data-section="informe">Informe Ejecutivo</div>
      </div>


    </aside>

    <main class="main">
      <section id="resumen" class="section panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Resumen General del Periodo</strong>
          <div class="small">√öltima actualizaci√≥n: <span id="ultimaAct">‚Äî</span></div>
        </div>

        <div class="kpis" style="margin-top:15px">
          <div class="kpi pedidos"><h3>Total Pedidos</h3><p id="k_totalPedidos">‚Äî</p></div>
          <div class="kpi ventas"><h3>Total Vendido</h3><p id="k_totalVentas">‚Äî</p></div>
          <div class="kpi promedio"><h3>Promedio por Pedido</h3><p id="k_promedio">‚Äî</p></div>
          <div class="kpi pedidos"><h3>Clientes √önicos</h3><p id="k_clientesUnicos">‚Äî</p></div>
          <div class="kpi promedio"><h3>Costo Domicilios</h3><p id="k_costoDomicilio">‚Äî</p></div>
        </div>

        <div class="panel" style="margin-top:15px;">
          <h4>üöÄ Tendencias Clave</h4>
          <ul class="small" id="tendenciasRapidas">
            <li>üìÜ Pedidos promedio por d√≠a: <span id="t_pedidosDia">‚Äî</span></li>
            <li>üí∏ Ticket promedio: <span id="t_ticketProm">‚Äî</span></li>
            <li>üìà Variaci√≥n de ventas (vs. periodo anterior): <span id="t_varVentas" style="font-weight:bold;">‚Äî</span></li>
            <li>üïí Hora pico de pedidos: <span id="t_horaPico">‚Äî</span></li>
          </ul>
        </div>


        <div class="charts">
          <div class="panel"><canvas id="chartVentasDia"></canvas></div>
          <div class="panel"><canvas id="chartVentasHora"></canvas></div>
          <div class="panel"><canvas id="chartTipoEntrega"></canvas></div>
          <div class="panel"><canvas id="chartMetodoPago"></canvas></div>
        </div>
        
        <div class="panel" style="margin-top:15px;">
            <h4>üî• Concentraci√≥n de Ventas: D√≠a vs Hora (Heatmap)</h4>
            <canvas id="chartHeatmap"></canvas>
        </div>
      </section>

      <section id="clientes" class="section panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Clientes - Rankings Top 50</strong>
          <div>
            <button id="exportClientes" class="ghost">Exportar Clientes CSV</button>
          </div>
        </div>

        <div style="margin-top:12px" class="info-box">
          An√°lisis de clientes por **frecuencia de pedidos** y **gasto total acumulado** en el periodo.
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:15px;margin-top:15px">
          <div class="panel">
            <h4>ü•á Top Clientes por Frecuencia</h4>
            <table id="tablaClientesFreq">
              <thead><tr><th>Cliente</th><th>Tel√©fono</th><th>Pedidos</th></tr></thead><tbody></tbody>
            </table>
          </div>

          <div class="panel">
            <h4>üí∞ Top Clientes por Gasto Total</h4>
            <table id="tablaClientesGasto">
              <thead><tr><th>Cliente</th><th>Tel√©fono</th><th>Gasto</th></tr></thead><tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="productos" class="section panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Productos Top 100</strong>
          <div><button id="exportProductos" class="ghost">Exportar Productos CSV</button></div>
        </div>

        <div style="margin-top:12px" class="info-box">Ranking por **cantidad de unidades vendidas** y por **ingresos estimados** (calculados del precio).</div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:15px;margin-top:15px">
          <div class="panel">
            <h4>üì¶ Top Productos (Cantidad)</h4>
            <table id="tablaProductosCantidad">
              <thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody></tbody>
            </table>
          </div>

          <div class="panel">
            <h4>üíµ Top Productos (Ingresos Estimados)</h4>
            <table id="tablaProductosIngreso">
              <thead><tr><th>Producto</th><th>Ingreso</th></tr></thead><tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="tendencias" class="section panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>An√°lisis de D√≠as y Productos</strong>
          <div class="small">Identificaci√≥n de **d√≠as de alto rendimiento** y **productos con mayor impacto**.</div>
        </div>

        <div style="margin-top:15px" class="charts">
          <div class="panel"><canvas id="chartDiaSemana"></canvas></div>
          <div class="panel"><canvas id="chartTopProductos"></canvas></div>
        </div>

        <div style="margin-top:15px" class="panel">
          <h4>üìä Estad√≠sticas Detalladas del Periodo</h4>
          <pre id="extraStats" class="report small">Cargando...</pre>
        </div>
      </section>

      <section id="informe" class="section panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Informe Ejecutivo Autom√°tico</strong>
          <div><button id="btnCopiar" class="ghost">Copiar Informe</button></div>
        </div>

        <div style="margin-top:12px" class="info-box report" id="informeText">Generando informe...</div>
      </section>
    </main>
  </div>

  <script>
  // 1. VARIABLE API_URL DECLARADA PARA SER ASIGNADA DESDE config.json
  let API_URL = ''; 

  // Registrar plugins de Chart.js
  Chart.register(ChartDataLabels);

  // ---------- utilidades ----------
  const fmtCOP = n => (Number(n)||0).toLocaleString('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0});
  const q = s => document.querySelector(s);
  const qAll = s => Array.from(document.querySelectorAll(s));

  let RAW_PEDIDOS = [];
  let charts = [];
  let statsGlobal; // Variable para almacenar las estad√≠sticas y usarlas en exportaciones

  // pesta√±as
  qAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=> {
      qAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      qAll('.section').forEach(s=>s.style.display='none');
      const targetSection = q('#'+tab.dataset.section);
      if (targetSection) targetSection.style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  /**
   * Carga datos de la API y los filtra por el rango seleccionado.
   * @param {string} rangoValue - '7', '30', '90' o 'todo'.
   * @returns {Array} Lista de pedidos filtrados.
   */
  async function loadRealData(rangoValue) {
    if (!API_URL) throw new Error("API_URL no est√° configurada. Revise config.json.");
    
    const res = await fetch(API_URL + '?t=' + Date.now());
    const allPedidos = await res.json();
    if(!Array.isArray(allPedidos)) throw new Error('Respuesta API no es un array de pedidos');
    
    // FIX CRUCIAL: Filtra la primera fila que contiene los encabezados literales.
    const dataPedidos = allPedidos.filter(p => p.tipoEntrega && p.tipoEntrega.toString().toLowerCase() !== 'tipoentrega');

    // Guardamos todos los pedidos limpios en RAW_PEDIDOS 
    RAW_PEDIDOS = Array.from(dataPedidos); 
    
    // Filtrar por rango
    const dias = rangoValue === 'todo' ? null : Number(rangoValue);
    const hoy = new Date();
    hoy.setHours(0,0,0,0); // Normalizar a medianoche para comparaci√≥n
    
    const filtrados = RAW_PEDIDOS.filter(p=>{
      if(rangoValue === 'todo') return true;
      if(!p.fecha) return false;
      const dt = parseFechaDDMMYYYY(p.fecha);
      if(!dt) return false;
      
      const diff = (hoy - dt) / (1000*60*60*24);
      // Incluir pedidos si est√°n dentro del rango de d√≠as (0 para hoy, 1 para ayer, etc.)
      return diff >= 0 && diff <= dias; 
    });
    
    q('#rangoLabel').textContent = q('#rango').options[q('#rango').selectedIndex].text;
    return filtrados;
  }

  function parseFechaDDMMYYYY(fechaStr){
    if(!fechaStr) return null;
    
    // Intenta formato YYYY-MM-DD
    if (fechaStr.includes('-')) {
        const partes = fechaStr.split('-');
        if(partes.length===3) {
            const y = Number(partes[0]);
            const m = Number(partes[1]);
            const d = Number(partes[2]);
            const dt = new Date(y, m - 1, d);
            if (dt && dt.getFullYear() === y && dt.getMonth() === m-1 && dt.getDate() === d) return dt;
        }
    } 
    // Intenta formato d/m/yyyy o dd/mm/yyyy
    else if (fechaStr.includes('/')) {
        const partes = fechaStr.split('/');
        if(partes.length===3) {
            const d = Number(partes[0]);
            const m = Number(partes[1]);
            const y = Number(partes[2]);
            const dt = new Date(y,m-1,d);
            // Revalida la fecha para evitar fechas inv√°lidas como 30/02/2025
            if (dt && dt.getFullYear() === y && dt.getMonth() === m-1 && dt.getDate() === d) return dt;
        }
    }
    return null;
  }


  // ---------- l√≥gica de c√°lculo de productos (LIMPIEZA AVANZADA) ----------
  function normalizeProductName(linea) {
    let cleanLine = linea.trim();
    
    // 1. Extraer Cantidad (ej. "2x" o "x3")
    let cantidad = 1;
    let cantMatch = cleanLine.match(/^(\d+)\s*[xX]\s*/); // 2x Product
    if (cantMatch) {
        cantidad = Number(cantMatch[1]);
        cleanLine = cleanLine.replace(cantMatch[0], '').trim();
    } else {
        cantMatch = cleanLine.match(/\s*[xX]\s*(\d+)$/); // Product x3
        if (cantMatch) {
            cantidad = Number(cantMatch[1]);
            cleanLine = cleanLine.replace(cantMatch[0], '').trim();
        }
    }
    
    // 2. Extraer Precio (PRIORIDAD: FORMATO NUEVO " - $DIGITOS")
    let precioEstimado = 0;
    
    let precioMatch = cleanLine.match(/\s+\-\s*\$?([\d\s\.,]+)$/); 
    
    if (precioMatch) {
        const precioStr = precioMatch[1] || '0';
        precioEstimado = Number(precioStr.replace(/[^0-9]/g, ''));
        // Eliminar el precio y el separador del nombre
        cleanLine = cleanLine.replace(precioMatch[0], '').trim();
    } else {
        // L√ìGICA DE RESPALDO (FORMATO ANTERIOR: PAR√âNTESIS ($DIGITOS))
        precioMatch = cleanLine.match(/\(\s*\$?([\d\s\.,]+)\s*\)/);
        if (precioMatch) {
            const precioStr = precioMatch[1] || '0';
            precioEstimado = Number(precioStr.replace(/[^0-9]/g, ''));
            // Eliminar el precio y el par√©ntesis del nombre
            cleanLine = cleanLine.replace(precioMatch[0], '').trim();
        }
    }

    // 3. Limpiar Nombre final
    let nombreProd = cleanLine.split(' - ')[0].trim(); // Quita cualquier remanente despu√©s de un guion
    
    // **AJUSTE CR√çTICO:** Eliminar cualquier patr√≥n de cantidad remanente del nombre limpio.
    // Esto asegura que 'La Atrevida x1' quede como 'La Atrevida'.
    nombreProd = nombreProd.replace(/\s*[xX]\s*\d+\s*/, '').trim(); 
    nombreProd = nombreProd.replace(/\s*\d+\s*[xX]\s*/, '').trim(); 

    nombreProd = nombreProd.replace(/\s{2,}/g, ' ').trim(); // Quita espacios dobles
    nombreProd = nombreProd.replace(/\s*\(.*\)$/, '').trim(); // Quita cualquier (observaci√≥n) final
    
    if (!nombreProd) nombreProd = 'Producto Desconocido';
    
    return { 
        nombre: nombreProd, 
        cantidad: cantidad, 
        precioEstimado: precioEstimado 
    };
  }

  function analyze(pedidos){
    // resultados agregados
    const resumen = {
      totalPedidos: pedidos.length,
      totalVentas: 0,
      subtotalSum:0,
      costoDomicilioSum:0,
      propinaSum:0,
      clientes: {},
      productos: {}, 
      ventasPorFecha: {},
      pedidosPorHora: Array(24).fill(0), 
      diaSemana: {0:0,1:0,2:0,3:0,4:0,5:0,6:0},
      tiposEntrega:{Domicilio:0,Mesa:0,"Recoger en Tienda":0,Otro:0},
      metodosPago: {},
      ventasPorDiaHora: Array.from({length:7},()=>Array(24).fill(0)) // Para el heatmap
    };

    pedidos.forEach(p=>{
      // Normalizar campos y obtener valores num√©ricos
      const totalPagar = Number(p.totalPagar) || 0;
      resumen.totalVentas += totalPagar;
      resumen.costoDomicilioSum += Number(p.costoDomicilio || 0) || 0;
      const prop = Number(p.propina || 0) || 0;
      resumen.propinaSum += prop;

      // cliente
      let nombre = (p.nombre || '').trim() || 'Cliente desconocido';
      let tel = String(p.telefono || '').trim().replace(/[^0-9+]/g, ''); 
      if (tel === '' || tel.toLowerCase() === 'null') tel = '‚Äî';
      const claveCliente = `${nombre} (${tel})`;
      resumen.clientes[claveCliente] = resumen.clientes[claveCliente] ? {
        pedidos: resumen.clientes[claveCliente].pedidos + 1,
        gasto: resumen.clientes[claveCliente].gasto + totalPagar
      } : {pedidos:1,gasto:totalPagar};

      // productos
      if (p.productos) {
        p.productos.split('\n').forEach(linea => {
            if (!linea.trim()) return;
            const item = normalizeProductName(linea);

            if (item.nombre) {
                const clave = item.nombre.toLowerCase();
                resumen.productos[clave] = resumen.productos[clave] || { nombre: item.nombre, cantidad: 0, ingreso: 0 };
                resumen.productos[clave].cantidad += item.cantidad;
                resumen.productos[clave].ingreso += item.precioEstimado * item.cantidad;
            }
        });
      }


      // ventas por fecha
      if(p.fecha){
        resumen.ventasPorFecha[p.fecha] = (resumen.ventasPorFecha[p.fecha] || 0) + totalPagar;
      }

      // hora
      let hh = 0;
      if(p.hora){
        hh = Number(String(p.hora).split(':')[0]) || 0;
        resumen.pedidosPorHora[hh] += 1;
      }

      // dia semana
      const dt = parseFechaDDMMYYYY(p.fecha);
      if(dt) {
        const diaIndex = dt.getDay();
        resumen.diaSemana[diaIndex] += totalPagar;
        resumen.ventasPorDiaHora[diaIndex][hh] += totalPagar; // Heatmap
      }

      // tipo entrega (normalizado)
      const te = (p.tipoEntrega || '').toLowerCase().trim();
      if (te.includes("domicilio")) resumen.tiposEntrega["Domicilio"]++;
      else if (te.includes("mesa")) resumen.tiposEntrega["Mesa"]++;
      else if (te.includes("recoger") || te.includes("tienda")) resumen.tiposEntrega["Recoger en Tienda"]++;
      else resumen.tiposEntrega["Otro"]++;


      // metodo de pago
      const mp = (p.metodoPago || 'Desconocido').toString();
      resumen.metodosPago[mp] = (resumen.metodosPago[mp] || 0) + totalPagar;
    });

    // ordenar y calcular
    const clientesArr = Object.entries(resumen.clientes).map(([k,v])=>{
      const match = k.match(/\((.*?)\)/);
      return {cliente:k.replace(/\s+\(.*?\)/,'').trim(), telefono:match?.[1]||'‚Äî', pedidos:v.pedidos, gasto:v.gasto};
    }).sort((a,b)=>b.pedidos - a.pedidos);
    
    const clientesPorGasto = Object.entries(resumen.clientes).map(([k,v])=>{
      const match = k.match(/\((.*?)\)/);
      return {cliente:k.replace(/\s+\(.*?\)/,'').trim(), telefono:match?.[1]||'‚Äî', pedidos:v.pedidos, gasto:v.gasto};
    }).sort((a,b)=>b.gasto - a.gasto);

    const productosArr = Object.values(resumen.productos).sort((a,b)=>b.cantidad - a.cantidad);
    const productosPorIngreso = Object.values(resumen.productos).sort((a,b)=>b.ingreso - a.ingreso);

    return {resumen, clientesArr, clientesPorGasto, productosArr, productosPorIngreso};
  }

  // ---------- UI render (Gr√°ficos y Tablas) ----------
  function renderResumen(stats){
    const r = stats.resumen;
    q('#k_totalPedidos').textContent = r.totalPedidos;
    q('#k_totalVentas').textContent = fmtCOP(r.totalVentas);
    q('#k_promedio').textContent = fmtCOP(r.totalPedidos ? (r.totalVentas / r.totalPedidos) : 0);
    q('#k_clientesUnicos').textContent = Object.keys(r.clientes).length;
    q('#k_costoDomicilio').textContent = fmtCOP(r.costoDomicilioSum);

    // === TENDENCIAS R√ÅPIDAS ===
    const diasAnalizados = Object.keys(r.ventasPorFecha).length || 1;
    const pedidosPorDia = r.totalPedidos / diasAnalizados;
    const ticketProm = r.totalPedidos ? r.totalVentas / r.totalPedidos : 0;

    const maxPedidos = Math.max(...r.pedidosPorHora);
    const maxHoraIndex = r.pedidosPorHora.findIndex(p => p === maxPedidos);
    const horaPico = `${String(maxHoraIndex).padStart(2,'0')}:00 (${maxPedidos} pedidos)`;

    // Comparativa con Periodo Anterior
    const rango = q('#rango').value;
    let prevVentas = 0;
    if (rango !== 'todo') {
      const dias = Number(rango);
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      const startPrev = new Date(); startPrev.setDate(hoy.getDate() - dias*2 + 1);
      const endPrev = new Date(); endPrev.setDate(hoy.getDate() - dias);

      RAW_PEDIDOS.forEach(p => {
        const dt = parseFechaDDMMYYYY(p.fecha);
        if (!dt) return;
        if (dt >= startPrev && dt <= endPrev) { 
          prevVentas += Number(p.totalPagar || 0);
        }
      });
    }
    
    let variacionText = '‚Äî';
    if (prevVentas > 0) {
      const growth = (((r.totalVentas - prevVentas) / prevVentas) * 100);
      const sign = growth >= 0 ? '‚ñ≤' : '‚ñº';
      const color = growth >= 0 ? '#28a745' : '#dc3545';
      variacionText = `<span style="color:${color}">${sign} ${Math.abs(growth).toFixed(1)}%</span>`;
    } else if (r.totalVentas > 0 && rango !== 'todo') {
      variacionText = '<span style="color:#ffc107">¬°Primer Periodo!</span>';
    }

    q('#t_pedidosDia').textContent = pedidosPorDia.toFixed(1);
    q('#t_ticketProm').textContent = fmtCOP(ticketProm);
    q('#t_varVentas').innerHTML = variacionText;
    q('#t_horaPico').textContent = horaPico;

    // charts
    destroyCharts();

    // Line Chart: Ventas por D√≠a
    const labelsDia = Object.keys(r.ventasPorFecha).sort((a,b)=>{
      const da = parseFechaDDMMYYYY(a), db = parseFechaDDMMYYYY(b);
      return (da?.getTime() || 0) - (db?.getTime() || 0);
    });
    const dataDia = labelsDia.map(l => r.ventasPorFecha[l] || 0);
    charts.push(new Chart(q('#chartVentasDia'),{
      type:'line',
      data:{labels:labelsDia,datasets:[{label:'Ventas Diarias',data:dataDia,borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#007bff',backgroundColor: 'rgba(0,123,255,0.1)', fill:true,tension:0.3, pointRadius: 3}]},
      options:{
        responsive:true,
        plugins:{legend:{display:false}, title:{display:true,text:'Tendencia de Ventas por D√≠a'}},
        scales:{y:{ticks:{callback:fmtCOP}}}
      }
    }));

    // Bar Chart: Pedidos por Hora
    charts.push(new Chart(q('#chartVentasHora'),{
      type:'bar',
      data:{labels:Array.from({length:24},(_,i)=>String(i).padStart(2,'0')+':00'),datasets:[{label:'Pedidos por hora',data:r.pedidosPorHora,backgroundColor:'#5b9cff'}]},
      options:{
        plugins:{legend:{display:false}, title:{display:true,text:'Pico de Pedidos por Hora'}},
        scales:{y:{beginAtZero:true}}
      }
    }));

    // Donut Chart: Tipo de Entrega
    const teLabels = Object.keys(r.tiposEntrega).filter(k => r.tiposEntrega[k] > 0);
    const teData = teLabels.map(k => r.tiposEntrega[k]);
    charts.push(new Chart(q('#chartTipoEntrega'),{
      type:'doughnut',
      data:{labels:teLabels,datasets:[{data:teData,backgroundColor:['#007bff','#28a745','#ffc107','#6c757d']}]},
      options:{plugins:{legend:{position:'bottom'}, title:{display:true,text:'Distribuci√≥n por Tipo de Entrega'}}}
    }));

    // Donut Chart: M√©todo de Pago
    const mpLabels = Object.keys(r.metodosPago).filter(k => r.metodosPago[k] > 0);
    const mpData = mpLabels.map(k => r.metodosPago[k]);
    charts.push(new Chart(q('#chartMetodoPago'),{
      type:'doughnut',
      data:{labels:mpLabels,datasets:[{data:mpData,backgroundColor:generateColors(mpLabels.length)}]},
      options:{plugins:{legend:{position:'bottom'}, title:{display:true,text:'Distribuci√≥n por M√©todo de Pago'}}}
    }));
    
    // Heatmap: D√≠a vs Hora
    const heatData = r.ventasPorDiaHora;
    const heatLabels = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    
    charts.push(new Chart(q('#chartHeatmap'),{
      type:'bar',
      data:{
        labels:Array.from({length:24},(_,i)=>String(i).padStart(2,'0')), 
        datasets:heatLabels.map((d,i)=>({
            label:d,
            data:heatData[i].map(v => v/1000), 
            stack:'stack1', 
            backgroundColor:generateColors(7)[i],
            barThickness: 'flex'
        }))
      },
      options:{
        responsive:true,
        indexAxis:'x',
        plugins:{
          legend:{position:'bottom', reverse:true},
          title:{display:true,text:'Concentraci√≥n de Ventas por Hora y D√≠a (Miles COP)'},
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) { label += ': '; }
                if (context.parsed.y !== null) { label += fmtCOP(context.parsed.y * 1000); }
                return label;
              }
            }
          }
        },
        scales: {
          x: {title:{display:true,text:'Hora del D√≠a'}, grid:{display:false}},
          y: {stacked:true, title:{display:true,text:'Ventas (Miles COP)'}, ticks:{callback: v => `${v}K`}}
        }
      }
    }));
  }

  // helpers
  function destroyCharts(){ charts.forEach(c=>{ if (c && c.destroy) c.destroy(); }); charts=[]; }

  function generateColors(n){
    const pal = ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#fd7e14','#20c997','#e83e8c','#6c757d','#00bcd4'];
    const out = [];
    for(let i=0;i<n;i++) out.push(pal[i%pal.length]);
    return out;
  }

  // render tablas clientes/productos
  function renderClientesTables(stats){
    const cf = stats.clientesArr.slice(0,50);
    const cg = stats.clientesPorGasto.slice(0,50);
    q('#tablaClientesFreq tbody').innerHTML = cf.map((c,i)=>`<tr><td>${i+1}. ${escapeHtml(c.cliente)}</td><td>${c.telefono}</td><td>${c.pedidos}</td></tr>`).join('');
    q('#tablaClientesGasto tbody').innerHTML = cg.map((c,i)=>`<tr><td>${i+1}. ${escapeHtml(c.cliente)}</td><td>${c.telefono}</td><td>${fmtCOP(c.gasto)}</td></tr>`).join('');
  }

  function renderProductosTables(stats){
    const pq = stats.productosArr;
    const pi = stats.productosPorIngreso;
    q('#tablaProductosCantidad tbody').innerHTML = pq.slice(0,100).map((p,i)=>`<tr><td>${i+1}. ${escapeHtml(p.nombre)}</td><td>${p.cantidad}</td></tr>`).join('');
    q('#tablaProductosIngreso tbody').innerHTML = pi.slice(0,100).map((p,i)=>`<tr><td>${i+1}. ${escapeHtml(p.nombre)}</td><td>${fmtCOP(p.ingreso)}</td></tr>`).join('');
  }

  // tendencias charts + extra stats + report
  function renderTendencias(stats){
    const r = stats.resumen;

    // Bar Chart: D√≠a de Semana
    const diaLabels = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
    const diaData = diaLabels.map((_,i)=> r.diaSemana[i] || 0);
    charts.push(new Chart(q('#chartDiaSemana'),{
      type:'bar',
      data:{labels:diaLabels,datasets:[{label:'Ventas por d√≠a de la semana',data:diaData,backgroundColor:'#7abaff'}]},
      options:{
        plugins:{legend:{display:false}, title:{display:true,text:'Ventas Totales por D√≠a de la Semana'}}, 
        scales:{y:{ticks:{callback:fmtCOP}}}
      }
    }));

    // Horizontal Bar Chart: Top Productos
    const topP = stats.productosArr.slice(0,10);
    charts.push(new Chart(q('#chartTopProductos'),{
      type:'bar',
      data:{labels: topP.map(p=>p.nombre), datasets:[{label:'Cantidad Vendida',data:topP.map(p=>p.cantidad),backgroundColor:generateColors(10)}]},
      options:{indexAxis:'y',plugins:{legend:{display:false}, title:{display:true,text:'Top 10 Productos por Cantidad Vendida'}}, scales:{x:{beginAtZero:true}}}
    }));

    // extra stats text
    const totalVentas = r.totalVentas;
    const promedio = r.totalPedidos ? totalVentas / r.totalPedidos : 0;
    const clientesUnicos = Object.keys(r.clientes).length;
    q('#extraStats').textContent = 
`Resumen Financiero y Operacional:

Total Ventas: ${fmtCOP(totalVentas)}
Total Pedidos: ${r.totalPedidos}
Ticket Promedio por Pedido: ${fmtCOP(promedio)}

Clientes √önicos Registrados: ${clientesUnicos}
Costo Total de Domicilios: ${fmtCOP(r.costoDomicilioSum)}
Propina Total Acumulada: ${fmtCOP(r.propinaSum)}
`;
  }

  // informe autom√°tico 
  function generarInforme(stats){
    const r = stats.resumen;
    const rango = q('#rango').value;
    let periodoDias = rango === 'todo' ? null : Number(rango);
    
    // construir texto
    let texto = `üìä INFORME EJECUTIVO DE ESTAD√çSTICAS\n\n`;
    texto += `Fecha de Generaci√≥n: ${new Date().toLocaleString()}\n`;
    texto += `Per√≠odo Analizado: ${q('#rangoLabel').textContent}\n`;
    texto += `--------------------------------------------------\n`;
    texto += `\nüéØ **Resumen de Alto Nivel:**\n`;
    texto += `Total Pedidos: ${r.totalPedidos}\n`;
    texto += `Total Ventas: ${fmtCOP(r.totalVentas)}\n`;
    texto += `Ticket Promedio por pedido: ${fmtCOP(r.totalVentas / (r.totalPedidos || 1))}\n`;
    texto += `Clientes √önicos: ${Object.keys(r.clientes).length}\n`;

    const topCliente = stats.clientesArr[0];
    if(topCliente) texto += `\nü•á Cliente M√°s Frecuente: ${topCliente.cliente} (${topCliente.telefono}) ‚Äî ${topCliente.pedidos} pedidos.\n`;
    const topProd = stats.productosArr[0];
    if(topProd) texto += `\nüì¶ Producto Top (Cantidad): ${topProd.nombre} ‚Äî ${topProd.cantidad} unidades.\n`;
    const topProdIngreso = stats.productosPorIngreso[0];
    if(topProdIngreso) texto += `üíµ Producto Top (Ingreso): ${topProdIngreso.nombre} ‚Äî ingresos ${fmtCOP(topProdIngreso.ingreso)}.\n`;

    // tipo de entrega dominante
    const maxEntrega = Object.entries(r.tiposEntrega).filter(([, count]) => count > 0).sort((a,b)=>b[1]-a[1])[0];
    if (maxEntrega) texto += `\nüöö Tipo de Entrega Dominante: ${maxEntrega[0]} (${maxEntrega[1]} pedidos).\n`;

    // m√©todo de pago dominante
    const maxPago = Object.entries(r.metodosPago).filter(([, count]) => count > 0).sort((a,b)=>b[1]-a[1])[0];
    if (maxPago) texto += `üí≥ M√©todo de Pago M√°s Usado: ${maxPago[0]} (Aprox. ${fmtCOP(maxPago[1])}).\n`;

    // variaci√≥n con periodo anterior (si aplica)
    if(periodoDias){
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      const start = new Date(); start.setDate(hoy.getDate() - periodoDias + 1);
      const prevStart = new Date(); prevStart.setDate(start.getDate() - periodoDias);
      const prevEnd = new Date(); prevEnd.setDate(start.getDate() - 1);

      let prevVentas = 0, prevPedidos = 0;
      RAW_PEDIDOS.forEach(p=>{
        const dt = parseFechaDDMMYYYY(p.fecha);
        if(!dt) return;
        if(dt >= prevStart && dt <= prevEnd){ prevVentas += Number(p.totalPagar||0); prevPedidos++; }
      });

      const growthVentas = prevVentas ? ((r.totalVentas - prevVentas) / prevVentas) * 100 : null;
      const growthPedidos = prevPedidos ? ((r.totalPedidos - prevPedidos) / prevPedidos) * 100 : null;

      texto += `\n--------------------------------------------------\n`;
      texto += `üìà **Comparativa con Periodo Anterior:**\n`;
      texto += `Per√≠odo Prev: ${prevStart.toLocaleDateString()} ‚Üí ${prevEnd.toLocaleDateString()}\n`;
      if(prevVentas > 0){
        const vsVentas = growthVentas >= 0 ? `‚ñ≤ +${growthVentas.toFixed(1)}%` : `‚ñº ${growthVentas.toFixed(1)}%`;
        const vsPedidos = growthPedidos >= 0 ? `‚ñ≤ +${growthPedidos.toFixed(1)}%` : `‚ñº ${growthPedidos.toFixed(1)}%`;
        texto += `Ventas: ${fmtCOP(r.totalVentas)} (vs ${fmtCOP(prevVentas)} previo. Variaci√≥n: ${vsVentas})\n`;
        texto += `Pedidos: ${r.totalPedidos} (vs ${prevPedidos} previo. Variaci√≥n: ${vsPedidos})\n`;
      } else if (r.totalVentas > 0) {
        texto += `Ventas: ${fmtCOP(r.totalVentas)}. No hay datos en el periodo anterior para comparar.\n`;
      } else {
         texto += `No hay suficientes datos para una comparativa significativa.\n`;
      }
    }

    q('#informeText').textContent = texto;
  }

  // ---------- export CSV ----------
  function exportTableToCSV(filename, rows){
    const csvContent = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  // escape HTML
  function escapeHtml(s){ 
    if (typeof s !== 'string') return s;
    return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); 
  }

  // ---------- cargar y montar ----------
  // 2. FUNCI√ìN DE CARGA DE DATOS RENOMBRADA
  async function cargarPedidos(){
    try{
      q('#estado').textContent = '‚è≥ Conectando analizando...';
      
      const filtrados = await loadRealData(q('#rango').value); 
      
      statsGlobal = analyze(filtrados); // Almacena las stats en global
      
      destroyCharts(); 
      
      renderResumen(statsGlobal);
      renderClientesTables(statsGlobal);
      renderProductosTables(statsGlobal);
      renderTendencias(statsGlobal);
      generarInforme(statsGlobal);

      q('#ultimaAct').textContent = (new Date()).toLocaleString();
      q('#estado').textContent = `‚úÖ Datos de ${statsGlobal.resumen.totalPedidos} pedidos listos`;
    }catch(e){
    }
  }

  // botones y eventos
  q('#btnRecargar').addEventListener('click', ()=> cargarPedidos());
  q('#rango').addEventListener('change', ()=> cargarPedidos());

  q('#exportClientes').addEventListener('click', ()=>{
    if (!statsGlobal) return alert('Carga los datos primero.');
    const rows = [['Cliente','Tel√©fono','Pedidos','Gasto Total']];
    statsGlobal.clientesArr.forEach(c => rows.push([c.cliente, c.telefono, c.pedidos, c.gasto]));
    exportTableToCSV('clientes_frecuencia_gasto.csv', rows);
  });

  q('#exportProductos').addEventListener('click', ()=>{
    if (!statsGlobal) return alert('Carga los datos primero.');
    const rows = [['Producto','Cantidad Vendida','Ingreso Estimado']];
    statsGlobal.productosArr.forEach(p => rows.push([p.nombre, p.cantidad, p.ingreso]));
    exportTableToCSV('productos_top.csv', rows);
  });

  q('#btnExport').addEventListener('click', ()=>{
    if (!statsGlobal) return alert('Carga los datos primero.');
    const rows = [['M√©trica','Valor']];
    const r = statsGlobal.resumen;
    rows.push(['Total Pedidos', r.totalPedidos]);
    rows.push(['Total Ventas', r.totalVentas]);
    rows.push(['Promedio por Pedido', r.totalPedidos ? r.totalVentas / r.totalPedidos : 0]);
    rows.push(['Clientes √önicos', Object.keys(r.clientes).length]);
    rows.push(['Costo Domicilios', r.costoDomicilioSum]);
    rows.push(['Propina Total', r.propinaSum]);
    exportTableToCSV('estadisticas_resumen_export.csv', rows);
  });

  q('#btnCopiar').addEventListener('click', ()=>{
    const text = q('#informeText').textContent;
    navigator.clipboard?.writeText(text).then(()=> alert('Informe copiado al portapapeles'));
  });

  // 3. INICIALIZACI√ìN: CARGA CONFIGURACI√ìN Y LUEGO LLAMA A cargarPedidos()
  (function init() {
    q('#estado').textContent = '‚è≥ Cargando configuraci√≥n desde config.json...';
    fetch("../config.json")
      .then(r => {
        if (!r.ok) {
          throw new Error(`Error de red: ${r.statusText} (${r.status})`);
        }
        return r.json();
      })
      .then(cfg => {
        API_URL = cfg.apiUrls.reciboBaseDatos || cfg.apiUrls.envioBaseDatos;
        if (!API_URL) {
            throw new Error("La URL de la API no se encontr√≥ en config.json.");
        }
        cargarPedidos(); // ‚úÖ llama a la funci√≥n principal
      })
      .catch(err => {
        console.error("‚ùå Error cargando config.json:", err);
        q('#estado').textContent = "‚ùå Error al cargar configuraci√≥n. Revise config.json.";
        alert(`Error al cargar config.json. Aseg√∫rate de que el archivo exista en la ruta correcta y est√© bien formado. Detalle: ${err.message}`);
      });
  })();

  </script>
</body>
</html>