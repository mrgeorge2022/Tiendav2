<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Factura</title>
  <link rel="icon" type="image/png" href="../img/icono_tienda.png">

  <style>
    body {
      font-family: "Inter", "Helvetica", Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #1a1a1a;
    }

    .page {
      background: #fff;
      margin: 20px auto;
      padding: 30px 25px;
      max-width: 800px;
      border-radius: 12px;
      box-sizing: border-box;
    }

    .header-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-bottom: 25px;
    }

    .header-column .logo {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      border-radius: 12px;
      overflow: hidden;
      background: #f1f1f1;
    }

    .header-column .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .store-info h2 {
      margin: 0;
      font-size: 12px;
      font-weight: 700;
      color: #111;
    }

    .store-info p {
      margin: 3px 0;
      font-size: 10px;
      color: #666;
      line-height: 1.3;
    }


    .factura-info {
      margin-top: 10px;
      font-size: 1rem;
      background: #f1f1f1;
      padding: 6px 12px;
      border-radius: 8px;
      display: inline-block;
    }

    .meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #1a1a1a;
      margin-bottom: 10px;
    }

    .meta .left {
      grid-column: 1 / span 2;
    }

    hr {
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 20px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: #f1f1f1;
      text-align: center;
      padding: 8px 5px;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      border-bottom: 1px solid #e0e0e0;
      padding: 5px 5px;
      vertical-align: top;
    }

    td.qty, td.price { text-align: center; }
    td.total { text-align: right; }

    tbody tr:nth-child(even) { background-color: #fafafa; }

    .totals {
      margin-top: 15px;
      padding: 10px;
      background: #fafafa;
    }

    .totals .row {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
    }

    .totals .row.total {
      font-weight: 700;
      border-top: 1px dashed #bbb;
      margin-top: 6px;
      padding-top: 8px;
    }

    .observaciones {
      margin-top: 25px;
      font-size: 0.95rem;
      padding: 10px 15px;
    }

    .footer {
      text-align: center;
      margin-top: 25px;
      font-size: 0.8rem;
      color: #666;
      line-height: 1.4;
    }

    .footer div:last-child {
      color: #999;
      font-size: 0.75rem;
    }

    .print-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    .print-actions button {
      padding: 8px 16px;
      border: none;
      background: #111;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .print-actions button:hover { background: #333; }

    @media print {
      .print-actions { display: none; }
      body { background: #fff; }
      .page { box-shadow: none; border-radius: 0; margin: 0; padding: 5mm; }
    }
  </style>
</head>

<body>
  <div class="page" id="page">
    <header class="header-column">
      <div class="logo">
        <img src="../img/icono_tienda.png" alt="Logo del restaurante">
      </div>
      <div class="store-info">
        <h2 id="store-name"></h2>
        <p id="store-address"><br></p>
        <p id="store-phone"></p>
      </div>

      <div class="factura-info">
        <span>FACTURA</span>
        <div id="factura-num" style="font-weight:700;font-size:16px"></div>
      </div>
    </header>

    <div class="meta">
      <div class="left">
        <span id="cliente-nombre">Cliente: ‚Äî</span><br>
        <span id="cliente-phone">Tel: ‚Äî</span><br>
        <span id="cliente-direccion">Direcci√≥n: ‚Äî</span><br>
        <div id="fecha">Fecha: ‚Äî</div>
        <div id="hora">Hora: ‚Äî</div>
        <div id="tipo-entrega">Tipo: ‚Äî</div>
      </div>
    </div>

    <hr />

    <table id="items-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th class="qty">Cant.</th>
          <th class="price">Precio</th>
          <th class="total">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totals">
      <div class="row"><div>Subtotal</div><div id="subtotal">$0</div></div>
      <div class="row"><div>Domicilio</div><div id="costo-domicilio">$0</div></div>
      <div class="row total"><div>Total sin propina</div><div id="total-sin-propina">$0</div></div>
      <div class="row"><div>Propina (10%)</div><div id="propina">$0</div></div>
      <div class="row total"><div>Total con propina</div><div id="total-pagar">$0</div></div>
    </div>

    <div class="observaciones">
      <strong>Observaciones:</strong>
      <div id="obs-text">‚Äî</div>
    </div>

    <div class="footer">
      <div>Gracias por su compra</div>
      <div>Documento impreso para respaldo del pedido</div>
    </div>

    <div class="print-actions">
      <button id="btn-print">üñ®Ô∏è Imprimir</button>
      <button id="btn-close">‚úñ Cerrar</button>
    </div>
  </div>

  <script>
async function cargarConfig() {
  try {
    const res = await fetch("../config.json");
    const data = await res.json();
    const sede = data.sede || {};
    document.getElementById("store-name").textContent = sede.nombre || "‚Äî";
    document.getElementById("store-address").textContent = sede.direccion || "‚Äî";
    document.getElementById("store-phone").textContent = "Tel: " + (sede.telefono || "‚Äî");
  } catch (e) {
    console.warn("No se pudo cargar config.json:", e);
  }
}

    (function () {
      const raw = localStorage.getItem('lastPedido');
      if (!raw) {
        document.getElementById('page').innerHTML =
          '<p style="padding:18px;text-align:center;color:#c00">No se encontr√≥ informaci√≥n del pedido.</p>';
        return;
      }

      const pedido = JSON.parse(raw);
      const formato = n => '$' + Number(n || 0).toLocaleString('es-CO');

      document.getElementById('factura-num').textContent = pedido.factura || "‚Äî";
      document.title = `${pedido.factura || "‚Äî"}`;
      document.getElementById('cliente-nombre').textContent = `Cliente: ${pedido.cliente?.nombre || ""}`;
      document.getElementById('cliente-phone').textContent = `Tel: ${pedido.cliente?.telefono || ""}`;
      document.getElementById('cliente-direccion').textContent = `Direcci√≥n: ${pedido.direccion || ""}`;
      document.getElementById('fecha').textContent = `Fecha: ${pedido.fecha || ""}`;
      document.getElementById('hora').textContent = `Hora: ${pedido.hora || ""}`;
      document.getElementById('tipo-entrega').textContent = `Tipo: ${pedido.tipoEntrega || ""}`;

      // Productos
      const tbody = document.querySelector('#items-table tbody');
      tbody.innerHTML = "";
      (pedido.productos || []).forEach(p => {
        const cantidad = Number(p.cantidad || 1);
        const nombreLimpio = (p.nombre || "").replace(/\s*x\d+\s*$/i, "");
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${nombreLimpio}</strong></td>
          <td class="qty">${cantidad}</td>
          <td class="price">${formato(p.precio)}</td>
          <td class="total">${formato((p.precio || 0) * cantidad)}</td>`;
        tbody.appendChild(tr);
      });

      // Totales
      const subtotal = Number(pedido.subtotal || 0);
      const domicilio = Number(pedido.costoDomicilio || 0);
      const totalSinPropina = subtotal + domicilio;
      const propina = totalSinPropina * 0.10;
      const totalConPropina = totalSinPropina + propina;

      document.getElementById('subtotal').textContent = formato(subtotal);
      document.getElementById('costo-domicilio').textContent = formato(domicilio);
      document.getElementById('total-sin-propina').textContent = formato(totalSinPropina);
      document.getElementById('propina').textContent = formato(propina);
      document.getElementById('total-pagar').textContent = formato(totalConPropina);
      document.getElementById('obs-text').textContent = pedido.observaciones || "";

      const metodo = document.createElement("div");
      metodo.classList.add("row");
      metodo.innerHTML = `<div><strong>M√©todo de pago</strong></div><div><strong>${pedido.metodoPago || "‚Äî"}</strong></div>`;
      document.querySelector(".totals").appendChild(metodo);

      document.getElementById("btn-print").addEventListener("click", () => window.print());
document.getElementById("btn-close").addEventListener("click", () => {
  window.location.href = "pedidos.html";
});

      cargarConfig(); // üî• carga los datos de la sede

      // üß≠ Si es domicilio y tiene ubicaci√≥n, generar QR exacto de Google Maps
      if (pedido.tipoEntrega === "Domicilio" && pedido.ubicacion) {
        const qrContainer = document.createElement("div");
        qrContainer.style.textAlign = "center";
        qrContainer.style.marginTop = "20px";

        const qrTitle = document.createElement("p");
        qrTitle.textContent = "Escanea para saber la ubicaci√≥n de este pedido";
        qrTitle.style.fontSize = "0.9rem";
        qrTitle.style.color = "#333";

        const qrImage = document.createElement("img");
        qrImage.alt = "C√≥digo QR ubicaci√≥n exacta";
        qrImage.style.width = "160px";
        qrImage.style.height = "160px";
        qrImage.style.marginTop = "8px";

        // üß© Aseguramos que el QR contenga TODO el enlace completo sin p√©rdida de caracteres
        const linkCompleto = pedido.ubicacion.trim();
        const linkCodificado = encodeURIComponent(linkCompleto);

        // URL exacta del QR, sin recortes ni concatenaciones
        qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?data=${linkCodificado}&size=160x160&margin=0&qzone=1`;

        qrContainer.appendChild(qrTitle);
        qrContainer.appendChild(qrImage);

        document.querySelector(".footer").before(qrContainer);

        // üîç Tambi√©n imprimimos el link debajo por respaldo
        const linkTexto = document.createElement("p");
        linkTexto.textContent = linkCompleto;
        linkTexto.style.fontSize = "0.75rem";
        linkTexto.style.color = "#666";
        linkTexto.style.wordBreak = "break-all";
        linkTexto.style.marginTop = "6px";
        qrContainer.appendChild(linkTexto);
      }


    })();
  </script>
</body>
</html>
