<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Pedidos</title>
  <link rel="icon" type="image/png" href="../img/icono_tienda.png">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 1rem;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #111;
      margin-bottom: 0.5rem;
    }

    .volver-admin {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .volver-admin button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: all 0.25s ease;
    }

    .volver-admin button:hover {
      background: linear-gradient(135deg, #0056b3, #004080);
      transform: translateY(-2px);
    }


    .estado {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      padding: 6px 12px;
      background: #fff;
      border-radius: 8px;
      display: inline-block;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      /* Mejoras de estilo para estados */
      font-weight: 600;
      min-width: 150px;
    }

    .estado.loading {
      color: #ff9800;
    }

    .estado.ok {
      color: #28a745;
      border: 1px solid #28a745;
    }

    .estado.error {
      color: #dc3545;
      border: 1px solid #dc3545;
    }
    
    .dashboard {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .dash-card {
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      text-align: center;
      min-width: 120px;
    }

    .dash-card h3 {
      margin: 0;
      font-size: 0.9rem;
      color: #007bff;
    }

    .dash-card p {
      margin: 4px 0 0;
      font-weight: bold;
      font-size: 1rem;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .filtros input,
    .filtros button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .filtros button {
      background: #007bff;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    .filtros button:hover {
      background: #0056b3;
    }

    /* ==== MES === */
    .mes-header {
      cursor: pointer;
      background: #e3e3e3;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    .mes-header:hover {
        background: #d3d3d3;
    }


    .mes-header span {
      font-size: 0.85rem;
      color: #555;
    }

    .pedidos-mes {
      margin-top: 5px;
      /* Ocultar contenido del mes */
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }
    
    .pedidos-mes.oculto {
        max-height: 0;
        margin-top: 0;
    }

    .pedido {
      background: #fff;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .pedido-header {
      padding: 12px 16px;
      background: #ffffff;
      /* gris claro elegante */
      color: #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: 600;
      flex-wrap: wrap;
      border-bottom: 1px solid #ddd;
      border-radius: 8px 8px 0 0;
      transition: background 0.2s ease, color 0.2s ease;
      font-size: 14px;
    }

    .pedido-header:hover {
      background: #e3e6eb;
      /* un poco m√°s oscuro al pasar el mouse */
      color: #000;
    }

    .pedido-header.new {
      background: #eaf4ff;
      /* tono sutil azul para nuevos */
      border-bottom: 1px solid #cfe3ff;
    }

    .pedido-header div {
      display: flex;
      line-height: 1.3;
      justify-content: space-between;
    }

    /* Detalles del pedido */
    .pedido-detalle {
      display: none;
      padding: 14px 16px;
      background: #fff;
      border-top: 1px solid #eee;
      color: #222;
    }

    .pedido.activo .pedido-detalle {
      display: block;
    }


    /* === NUEVO ESTILO PARA CABECERA DE PEDIDO === */
    .pedido-info {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .pedido-linea {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .pedido-nombre {
      font-weight: 600;
      color: #222;
      font-size: 0.95rem;
    }

    .pedido-fecha {
      font-size: 0.85rem;
      color: #666;
    }

    .pedido-factura {
      color: #007bff;
      font-weight: bold;
      margin-top: 2px;
      font-size: 0.9rem;
    }


    /* Lista de productos */
    .productos {
      background: #f9f9f9;
      padding: 8px 10px;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.85rem;
      margin-top: 6px;
      border: 1px solid #eee;
    }

    /* Bot√≥n de factura */
    .boton-factura {
      margin-top: 10px;
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.25s ease;
    }

    .boton-factura:hover {
      background: #0056b3;
    }


    .cargando {
      text-align: center;
      color: #666;
      font-size: 1rem;
      padding: 20px;
    }

    /* === ESTILO PARA BOT√ìN ELIMINAR === */
    .boton-eliminar {
      background: #dc3545;
      /* Rojo de peligro */
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.25s ease;
      margin-top: 10px;
    }

    .boton-eliminar:hover {
      background: #c82333;
    }

    /* Para que los botones se vean bien en m√≥vil */
    .pedido-detalle button {
      display: block;
      width: 100%;
      box-sizing: border-box;
      margin-top: 10px;
    }

    @media (min-width: 600px) {
      .pedido-detalle button {
        display: inline-block;
        width: auto;
        margin-right: 10px;
        /* Separaci√≥n horizontal en PC */
      }
    }
  </style>
</head>

<body>
  <h1>Panel de Pedidos</h1>

  <div class="volver-admin">
    <button onclick="window.location.href='admin.html'">‚¨ÖÔ∏è Admin</button>
    <div class="estado loading">Conectando...</div>
  </div>


  <div class="filtros">
    <input type="text" id="buscar" placeholder="Buscar por nombre o factura...">
    <input type="date" id="fechaFiltro">
    <button id="filtrarBtn">üîç Buscar</button>
    <button id="recargarBtn">üîÉ Recargar</button>
  </div>

  <div id="contenedorPedidos">
    <div class="cargando">Cargando pedidos...</div>
  </div>

  <audio id="alertaAudio" src="https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3"></audio>

  <script>

    const contenedor = document.getElementById("contenedorPedidos");
    const estado = document.querySelector(".estado");
    const audio = document.getElementById("alertaAudio");

    let pedidosGlobal = [];
    let ultimasFacturas = new Set();
    let horaConexion = null;
    let intervaloDuracion = null;
    let API_URL = ''; // Se inicializa para evitar errores antes de cargar config.json

    const formatoCOP = valor => {
      const n = Number(valor) || 0;
      return n.toLocaleString("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 });
    };

    async function cargarPedidos(auto = false) {
      estado.className = "estado loading";
      estado.textContent = "Actualizando...";

      if (!auto) {
        recargarBtn.disabled = true;
        recargarBtn.textContent = "‚è≥ Actualizando...";
      }


      try {
        const res = await fetch(API_URL + "?t=" + Date.now());
        const data = await res.json();

        if (!horaConexion) {
          horaConexion = new Date();
          iniciarRelojConexion();
        }

        const nuevasFacturas = data.map(p => p.numeroFactura);
        const nuevos = nuevasFacturas.filter(f => !ultimasFacturas.has(f));

        if (ultimasFacturas.size > 0 && nuevos.length > 0) {
          audio.play();
          mostrarAvisoNuevoPedido();
        }

        ultimasFacturas = new Set(nuevasFacturas);
        pedidosGlobal = data;
        mostrarPedidos(data, nuevos);

        estado.className = "estado ok";
        actualizarEstadoConTiempo();
      } catch (error) {
        console.error("Error al cargar pedidos:", error);
        contenedor.innerHTML = "<p class='cargando'>Error al cargar pedidos.</p>";
        estado.className = "estado error";
        estado.textContent = "Error de conexi√≥n";
      }

      finally {
        if (!auto) {
          recargarBtn.disabled = false;
          recargarBtn.textContent = "üîÉ Recargar";
        }
      }

    }

    function mostrarPedidos(pedidos, nuevasFacturas = []) {
      if (!pedidos || pedidos.length === 0) {
        contenedor.innerHTML = "<p class='cargando'>No hay pedidos registrados.</p>";
        return;
      }

      const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      const pedidosPorMes = {};

      pedidos.forEach(p => {
        if (!p.fecha) return;
        const partes = p.fecha.split("/");
        if (partes.length !== 3) return;
        const mes = partes[1].padStart(2, "0");
        if (!pedidosPorMes[mes]) pedidosPorMes[mes] = [];
        pedidosPorMes[mes].push(p);
      });

      contenedor.innerHTML = "";

      Object.keys(pedidosPorMes).sort((a, b) => b - a).forEach(mes => {
        const headerMes = document.createElement("div");
        headerMes.className = "mes-header";
        headerMes.innerHTML = `<span>${mesesNombres[Number(mes) - 1]}</span>`;
        contenedor.appendChild(headerMes);

        const bloqueMes = document.createElement("div");
        bloqueMes.className = "pedidos-mes";
        
        pedidosPorMes[mes].slice().reverse().forEach(p => {
          const rowIndex = p.rowIndex;
          const numFactura = (p.numeroFactura || "SIN N√öMERO").replace(/'/g, "\\'"); // Escapar comillas para JS
          
          const div = document.createElement("div");
          div.className = "pedido";
          div.innerHTML = `
            <div class="pedido-header">
              <div class="pedido-info">
                <div class="pedido-linea">
                  <span class="pedido-nombre">${p.nombre || "Cliente sin nombre"}</span>
                  <span class="pedido-fecha">${p.fecha || "‚Äî"} ${p.hora || ""}</span>
                </div>
                <div class="pedido-factura">${p.numeroFactura || "‚Äî"}</div>
              </div>
            </div>
            <div class="pedido-detalle">
              <p><strong>Tipo Entrega:</strong> ${p.tipoEntrega || "‚Äî"}</p>
              <p><strong>Tel√©fono:</strong> ${p.telefono ?? "0"}</p>
              ${p.mesa ? `<p><strong>Mesa:</strong> ${p.mesa}</p>` : ""}
              ${p.direccion ? `<p><strong>Direcci√≥n:</strong> ${p.direccion}</p>` : ""}
              ${p.puntoReferencia ? `<p><strong>Punto Ref:</strong> ${p.puntoReferencia}</p>` : ""}
              <p><strong>Productos:</strong></p>
              <div class="productos">${(p.productos || "").replace(/\n/g, "<br>")}</div>
              <p><strong>Total Productos:</strong> ${formatoCOP(p.totalProductos)}</p>
              <p><strong>Costo Domicilio:</strong> ${formatoCOP(p.costoDomicilio)}</p>
              <p><strong>Total a Pagar:</strong> ${formatoCOP(p.totalPagar)}</p>
              <p><strong>M√©todo de Pago:</strong> ${p.metodoPago || "‚Äî"}</p>
              ${p.ubicacionGoogleMaps ? `<p><strong>Ubicaci√≥n:</strong> <a href="${p.ubicacionGoogleMaps}" target="_blank">Ver mapa</a></p>` : ""}
              ${p.observaciones ? `<p><strong>Observaciones:</strong> ${p.observaciones}</p>` : ""}
              <button class="boton-factura">üëÅÔ∏è Ver Factura</button>
              
              <button class="boton-eliminar" data-row-index="${rowIndex}" onclick="eliminarPedidoAPI(${rowIndex}, '${numFactura}')">üóëÔ∏è Eliminar</button> ¬†¬† ¬† ¬† ¬† ¬† ¬† 
            </div>
          `;
          div.querySelector(".pedido-header").addEventListener("click", () => div.classList.toggle("activo"));
          div.querySelector(".boton-factura").addEventListener("click", () => {
            let productosArray = [];
            if (typeof p.productos === "string") {
              productosArray = p.productos.split("\n").filter(x => x.trim() !== "").map(linea => {
                const partes = linea.split("-").map(x => x.trim());
                return { nombre: partes[0], cantidad: 1, precio: Number((partes[1] || "0").replace(/\D/g, "")) || 0 };
              });
            }
            const pedidoLocal = {
              tipoEntrega: p.tipoEntrega,
              factura: p.numeroFactura,
              fecha: p.fecha,
              hora: p.hora,
              cliente: { nombre: p.nombre, telefono: p.telefono ?? "0", mesa: p.mesa },
              direccion: p.direccion,
              productos: productosArray,
              subtotal: Number(p.totalProductos || 0),
              costoDomicilio: Number(p.costoDomicilio || 0),
              totalPagar: Number(p.totalPagar || 0),
              metodoPago: p.metodoPago,
              observaciones: p.observaciones,
              ubicacion: p.ubicacionGoogleMaps || ""
            };
            localStorage.setItem("lastPedido", JSON.stringify(pedidoLocal));
            window.open("facturalocal.html", "_blank");
          });
          bloqueMes.appendChild(div);
        });
        contenedor.appendChild(bloqueMes);

        // Toggle para ocultar/mostrar los pedidos del mes
        headerMes.addEventListener("click", () => bloqueMes.classList.toggle("oculto"));
      });
    }

    // üî• FUNCI√ìN MODIFICADA: Ahora recibe y usa el n√∫mero de factura
    async function eliminarPedidoAPI(rowIndex, numeroFactura) {
        if (rowIndex <= 1) { 
            alert("Error: No se puede eliminar la fila de encabezado.");
            return;
        }

        // Usa el n√∫mero de factura en la confirmaci√≥n
        if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que deseas ELIMINAR el pedido con FACTURA ${numeroFactura}? Esta acci√≥n es irreversible.`)) {
            return;
        }

        const btn = document.querySelector(`.boton-eliminar[data-row-index="${rowIndex}"]`);
        // Usamos el bot√≥n de factura como fallback si el de eliminar no se encuentra (caso extra√±o)
        const finalBtn = btn || document.querySelector('.boton-factura'); 
        
        const originalText = finalBtn.textContent;
        finalBtn.disabled = true;
        finalBtn.textContent = 'Eliminando...';
        
        // Llama a la API con action=delete y el rowIndex
        const urlDelete = `${API_URL}?action=delete&rowIndex=${rowIndex}`;

        try {
            const response = await fetch(urlDelete, { method: 'GET' });
            const data = await response.json();

            if (data.status === 'ok') {
                // üî• CAMBIO EN EL MENSAJE DE √âXITO
                alert(`‚úÖ Pedido con FACTURA ${numeroFactura} eliminado con √©xito.`);
                // Recarga los pedidos para actualizar la lista
                cargarPedidos(false);
            } else {
                throw new Error(data.message || 'Error desconocido al eliminar.');
            }

        } catch (error) {
            console.error("Error al eliminar el pedido:", error);
            // üî• CAMBIO EN EL MENSAJE DE ERROR
            alert(`‚ùå Error al eliminar el pedido con FACTURA ${numeroFactura}. Verifique la API y la consola.`);
            finalBtn.disabled = false;
            finalBtn.textContent = originalText;
        }
    }

    function filtrarPedidos() {
      const texto = document.getElementById("buscar").value.toLowerCase();
      const fechaFiltro = document.getElementById("fechaFiltro").value;

      const filtrados = pedidosGlobal.filter(p => {
        const coincideTexto =
          (p.nombre || "").toLowerCase().includes(texto) ||
          (p.numeroFactura || "").toLowerCase().includes(texto);

        let coincideFecha = true;
        if (fechaFiltro && p.fecha) {
          const partes = p.fecha.split("/");
          if (partes.length === 3) {
            const fechaPedido = `${partes[2]}-${partes[1].padStart(2, "0")}-${partes[0].padStart(2, "0")}`;
            coincideFecha = fechaPedido === fechaFiltro;
          } else {
            coincideFecha = false;
          }
        }

        return coincideTexto && coincideFecha;
      });

      mostrarPedidos(filtrados);
    }

    document.getElementById("filtrarBtn").addEventListener("click", filtrarPedidos);
    const recargarBtn = document.getElementById("recargarBtn");
    recargarBtn.addEventListener("click", () => cargarPedidos(false));

    function mostrarAvisoNuevoPedido() {
      document.title = "¬°Nuevo pedido!";
      estado.style.boxShadow = "0 0 8px #28a745";
      setTimeout(() => {
        document.title = "Panel de Pedidos";
        estado.style.boxShadow = "";
      }, 3000);
    }

    function iniciarRelojConexion() {
      if (intervaloDuracion) clearInterval(intervaloDuracion);
      intervaloDuracion = setInterval(actualizarEstadoConTiempo, 1000);
    }

    function actualizarEstadoConTiempo() {
      if (!horaConexion) return;
      const ahora = new Date();
      const dif = Math.floor((ahora - horaConexion) / 1000);
      const horas = Math.floor(dif / 3600);
      const minutos = Math.floor((dif % 3600) / 60);
      const segundos = dif % 60;
      const tiempo = (horas > 0 ? horas + "h " : "") + (minutos > 0 ? minutos + "m " : "") + segundos + "s";
      const horaStr = horaConexion.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });
      estado.textContent = `üü¢ Conectado desde ${horaStr} (${tiempo})`;
    }


    fetch("../config.json")
      .then(r => r.json())
      .then(cfg => {
        API_URL = cfg.apiUrls.reciboBaseDatos || cfg.apiUrls.envioBaseDatos;
        console.log("‚úÖ API cargada desde config.json:", API_URL);
        cargarPedidos(); // ‚úÖ se llama solo aqu√≠
      })
      .catch(err => {
        console.error("‚ùå Error cargando config.json:", err);
        document.querySelector(".estado").textContent = "Error al cargar configuraci√≥n";
      });


  </script>
</body>

</html>